(()=>{var e={880:()=>{function e(e){if(/^\d{2}\/\d{2}\/\d{4} \d{2}:\d{2}$/.test(e))return e;if(/^\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}$/.test(e)){const[t,i]=e.split(" "),[a,s,n]=t.split("-"),[o,r]=i.split(":");return`${n}/${s}/${a} ${o}:${r}`}throw new Error("Invalid date format")}ko.components.register("time-slot-pill",{viewModel:function(t){const i=this;i.schedule=t.schedule,i.selectedResources=t.selectedResources,console.log(t),i.date=t.date,i.options={hour:"2-digit",minute:"2-digit"},console.log(i.date),i.startTime=ko.computed((()=>luxon.DateTime.fromFormat(e(i.date.from_),"dd/MM/yyyy HH:mm").toJSDate())),i.endTime=ko.computed((()=>luxon.DateTime.fromFormat(e(i.date.to_),"dd/MM/yyyy HH:mm").toJSDate())),i.toDateStr=e=>`${e.getDate()}. ${monthNamesShort[e.getMonth()].toLowerCase()}`,i.toTimeStr=(e,t)=>t?`${e.toLocaleTimeString("no",i.options).replace(":",".")} -\n                ${t.toLocaleTimeString("no",i.options).replace(":",".")}`:e.toLocaleTimeString("no",i.options).replace(":","."),i.removeDate=t.removeDate,i.error=ko.computed((()=>{if(!i.schedule||!i.selectedResources)return!1;const e={date:luxon.DateTime.fromJSDate(i.startTime()).toFormat("yyyy-MM-dd"),from:luxon.DateTime.fromJSDate(i.startTime()).toFormat("HH:mm:ss"),to:luxon.DateTime.fromJSDate(i.endTime()).toFormat("HH:mm:ss"),resources:i.selectedResources()},t=i.schedule().find((t=>function(e,t){if(e.date!==t.date)return!1;if("allocation"===t.type||"booking"===t.type)return!1;const i=e.from<t.to&&e.to>t.from,a=e.resources.some((e=>t.resources.some((t=>e.id===t.id))));return i&&a}(e,t)));return t?`${e.resources.find((e=>t.resources.some((t=>t.id===e.id)))).name} ikke tilgjengelig`:void 0}))},template:'\n\n        <div class="pill pill--secondary" data-bind="css: {\'pill--error\': error}">\n            \x3c!-- ko if: startTime().getMonth() === endTime().getMonth() && startTime().getFullYear() === endTime().getFullYear() && startTime().getDate() === endTime().getDate() --\x3e\n            <div class="pill-label">\n                <span className="text-primary text-bold" data-bind="text: toDateStr(startTime())"></span>\n            </div>\n            <div class="pill-divider"></div>\n            <div class="pill-time"\n                 data-bind="text: toTimeStr(startTime(), endTime()), css: {\'last-child\': !removeDate}">\n\n            </div>\n            \x3c!-- /ko --\x3e\n            \x3c!-- ko ifnot: (startTime().getMonth() === endTime().getMonth() && startTime().getFullYear() === endTime().getFullYear() && startTime().getDate() === endTime().getDate()) --\x3e\n            <div class="pill-content gap-1">\n                <div class="date"><span class="text-primary text-bold" data-bind="text: toDateStr(startTime())"></span>\n                    <span data-bind="text: toTimeStr(startTime())"></span>\n                </div>\n                <span> - </span>\n                <div class="time"><span class="text-primary text-bold" data-bind="text: toDateStr(endTime())"></span>\n                    <span data-bind="text: toTimeStr(endTime())"></span>\n                </div>\n            </div>\n\n            \x3c!-- /ko --\x3e\n\n            \x3c!-- ko if: !!removeDate --\x3e\n            <button class="pill-icon" data-bind="click: removeDate"><i class="pill-cross"></i></button>\n            \x3c!-- /ko --\x3e\n\n        </div>\n        \x3c!-- ko if: error --\x3e\n        <div class="d-flex align-items-center gap-2">\n            <svg class="font-size-small" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg">\n                <path d="M6.00011 0.75C6.33292 0.75 6.63996 0.925781 6.80871 1.21406L11.8712 9.83906C12.0423 10.1297 12.0423 10.4883 11.8759 10.7789C11.7095 11.0695 11.3978 11.25 11.0626 11.25H0.937611C0.602455 11.25 0.290736 11.0695 0.12433 10.7789C-0.042076 10.4883 -0.0397323 10.1273 0.129018 9.83906L5.19152 1.21406C5.36027 0.925781 5.6673 0.75 6.00011 0.75ZM6.00011 3.75C5.68839 3.75 5.43761 4.00078 5.43761 4.3125V6.9375C5.43761 7.24922 5.68839 7.5 6.00011 7.5C6.31183 7.5 6.56261 7.24922 6.56261 6.9375V4.3125C6.56261 4.00078 6.31183 3.75 6.00011 3.75ZM6.75011 9C6.75011 8.80109 6.67109 8.61032 6.53044 8.46967C6.38979 8.32902 6.19902 8.25 6.00011 8.25C5.8012 8.25 5.61043 8.32902 5.46978 8.46967C5.32913 8.61032 5.25011 8.80109 5.25011 9C5.25011 9.19891 5.32913 9.38968 5.46978 9.53033C5.61043 9.67098 5.8012 9.75 6.00011 9.75C6.19902 9.75 6.38979 9.67098 6.53044 9.53033C6.67109 9.38968 6.75011 9.19891 6.75011 9Z"\n                      fill="#B00020"/>\n            </svg>\n            <span class="text-small text-red-error" data-bind="text: error"></span>\n        </div>\n        \x3c!-- /ko --\x3e\n    '})},940:()=>{if(!globalThis.trans){globalThis.translations=ko.observable({});const e=phpGWLink("bookingfrontend/lang.php",null,!0);fetch(e).then((e=>e.json())).then((e=>globalThis.translations(e))),globalThis.trans=(e,t,...i)=>{const a=globalThis.translations(),s=e=>a[e]&&a[e][t]?a[e][t].replace(/%\d+/g,(e=>{const t=parseInt(e.substring(1))-1;return void 0!==i[t]?i[t]:e})):null;if(Array.isArray(e))for(let t=0;t<e.length;t++){const i=s(e[t]);if(null!==i)return i}else{const t=s(e);if(null!==t)return t}if(!Array.isArray(e)||!e.includes("common")){const e=s("common");if(null!==e)return e}return`Missing translation for [${Array.isArray(e)?e.join(", "):e}][${t}]`};class t{constructor(e,t){let i=t.templateNodes.map((e=>e.textContent));1===i.length&&i[0].includes(":")&&(i=i[0].split(":")),i=i.map((e=>e.trim())),i.length>=2?(this.tag=ko.observable(i[1]),this.group=ko.observable(i[0])):(this.tag="function"==typeof e.tag?e.tag:ko.observable(e.tag),this.group="function"==typeof e.group?e.group:ko.observable(e.group)),this.suffix=ko.observable(e.suffix||""),this.args=ko.observable(e.args),this.translations=globalThis.translations,this.translated=ko.computed((()=>{if(self.translations&&self.translations()&&Object.keys(self.translations()).length>0&&this.group&&this.tag)return globalThis.trans(this.group(),this.tag(),this.args())+this.suffix()}))}}ko.components.register("trans",{viewModel:{createViewModel:function(e,i){return new t(e,i)}},template:"\x3c!--ko text: translated()--\x3e\x3c!--/ko--\x3e"})}}},t={};function i(a){var s=t[a];if(void 0!==s)return s.exports;var n=t[a]={exports:{}};return e[a](n,n.exports,i),n.exports}(()=>{"use strict";function e(e,t,i,a){if(a){const e=a.split("/").filter((e=>""!==e&&!e.includes("http")));a="//"+e.slice(0,e.length-1).join("/")+"/"}const s=(a||strBaseURL).split("?");let n=s[0]+e+"?";null==t&&(t=new Object);for(const e in t)n+=e+"="+t[e]+"&";return s[1]&&(n+=s[1]),i&&(n+="&phpgw_return_as=json"),n}i(940),$(document).ready((function(){$("input[type=radio][name=select_template]").change((function(){var t=$(this).val(),i=e("bookingfrontend/",{menuaction:"bookingfrontend.preferences.set"},!0);$.ajax({type:"POST",dataType:"json",data:{template_set:t},url:i,success:function(e){location.reload(!0)}})})),$("input[type=radio][name=select_language]").change((function(){var t=$(this).val(),i=e("bookingfrontend/",{menuaction:"bookingfrontend.preferences.set"},!0);$.ajax({type:"POST",dataType:"json",data:{lang:t},url:i,success:function(e){location.reload(!0)}})}))})),i(880);class t{constructor(e){this.applicationCartItems=e.applicationCartItems,this.cartElementExpanded=ko.observable(!0),this.popperInstance=ko.observable(),this.isVisible=ko.observable(!1),this.deleteItem=e.deleteItem,this.applicationCartItems.subscribe((e=>console.log(e)))}initializePopper(e){const t=e.previousElementSibling;this.popperInstance(new Popper(t,e,{placement:"bottom-end",strategy:"fixed"}))}destroyPopperInstance(){this.popperInstance()&&(this.popperInstance().destroy(),this.popperInstance(null))}togglePopper(e=void 0){let t=this.popperInstance();t&&(this.isVisible(e||!this.isVisible()),t.update())}toggleCartExpansion(){this.cartElementExpanded(!this.cartElementExpanded())}popperAttr=ko.computed((()=>this.isVisible&&this.isVisible()?{"data-show":""}:{}))}ko.components.register("shopping-basket",{viewModel:{createViewModel:(e,i)=>new t(e,i)},template:'\n        <button class="pe-btn menu__toggler" type="button" aria-expanded="false"\n                data-bind="click: () => togglePopper()">\n    <span class="text">\n        <i class="fa-solid fa-basket-shopping"></i>\n        <span class="badge badge-light" style="position: absolute;top: -5px;"\n              data-bind="visible: applicationCartItems().length > 0, text: applicationCartItems().length">-1\n        </span>\n    </span>\n        </button>\n        <div class="poppercontent"\n             style="z-index: 11"\n             data-bind="withAfterRender: {afterRender: (d) => initializePopper(d)}, visible: applicationCartItems().length > 0 && isVisible, attr: popperAttr()">\n            <div class="dialog-container">\n                <div class="dialog-header">\n                    <span class="dialog-title">Søknader klar for innsending</span>\n                    <button type="button" class="btn-close btn-close-white" data-bind="click: () => togglePopper(false)"\n                            aria-label="Close"></button>\n                </div>\n                <div class="dialog-ingress">\n                    <p>Her er en oversikt over dine søknader som er klar for innsending og godkjennelse.</p>\n                </div>\n                <div class="dialog-content">\n                    \x3c!-- Content goes here --\x3e\n                    <div class="article-table-wrapper" data-bind="visible: cartElementExpanded">\n                        <div data-bind="foreach: applicationCartItems">\n\n                            <div class="article-table-header">\n                                <div class="resource-name" data-bind="text: building_name"></div>\n                                <div class="resource-expand float-right">\n                                    <span class="far fa-trash-alt mr-2" data-bind="click: $parent.deleteItem"></span>\n                                </div>\n                            </div>\n                            <div class="category-table">\n                                \x3c!-- ko foreach: { data: resources, as: \'item\' } --\x3e\n                                \n                                    <div class="category-header">\n                                        <div class="category-article-row">\n                                        <div class="category-name" data-bind="text: item.name"></div>\n                                        </div>\n                                    </div>\n\n                                \x3c!-- /ko --\x3e\n                                <div class="category-articles">\n                                    <div class="category-article-row">\n                                        \x3c!-- ko foreach: { data: dates, as: \'s\' } --\x3e\n                                        <time-slot-pill params="date: s"></time-slot-pill>\n                                        \x3c!-- /ko --\x3e\n                                        \n                                    </div>\n                                </div>\n                                \n                        </div>\n                    </div>\n                </div>\n            </div>\n            <div class="dialog-actions">\n                <a class="pe-btn pe-btn-primary pe-btn-colour-primary link-text link-text-white d-flex gap-3"\n                   data-bind="attr: { href: phpGWLink(\'bookingfrontend/\', {menuaction:\'bookingfrontend.uiapplication.add_contact\' }, false) } ">\n                    <div class="text-bold">\n                        <trans params="group: \'bookingfrontend\', tag:\'complete_applications\'"></trans>\n                    </div>\n                    <div class="text-bold d-flex align-items-center">\n                        <i class="fa-solid fa-arrow-right-long"></i>\n                    </div>\n                </a>\n            </div>\n        </div>\n        </div>\n    '});let a=new class{constructor(){this.applicationCartItems=ko.observableArray([]),this.applicationCartItemsEmpty=ko.observable(!1),this.visible=ko.observable(!0),this.initializeCart()}initializeCart(){this.getApplicationsCartItems()}deleteItem(t){console.log("got delete request");const i=e("bookingfrontend/",{menuaction:"bookingfrontend.uiapplication.delete_partial"},!0);confirm("Do you want to delete this application?")&&fetch(i,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:t.id})}).then((e=>e.json())).then((()=>this.getApplicationsCartItems())).catch((e=>console.error("Error:",e)))}getApplicationsCartItems(){const t=e("bookingfrontend/",{menuaction:"bookingfrontend.uiapplication.get_partials"},!0);fetch(t).then((e=>e.json())).then((e=>this.updateCartItems(e))).catch((e=>console.error("Error fetching cart items:",e)))}updateCartItems(e){const{list:t,total_sum:i}=e;this.applicationCartItemsEmpty(t.length<1),this.applicationCartItems(t.map((e=>({...e,dates:e.dates.map((e=>{const t=new Date(e.from_.replace(" ","T"));t.setHours(e.from_.substring(11,13)),t.setMinutes(e.from_.substring(14,16));const i=new Date(e.to_.replace(" ","T"));return i.setHours(e.to_.substring(11,13)),i.setMinutes(e.to_.substring(14,16)),{date:formatSingleDateWithoutHours(t),from_:e.from_,to_:e.to_,periode:formatPeriodeHours(t,i)}})),resources:ko.observableArray(e.resources.map((e=>({...e})))),joinedResources:e.resources.map((e=>e.name)).join(", ")}))))}};var s;s=()=>{const e=document.getElementById("application-cart-container")||document.getElementById("applications-cart-content");e&&(console.log("INITIALISING CART"),ko.applyBindings(a,e))},"complete"===document.readyState||"interactive"===document.readyState?setTimeout(s,1):document.addEventListener("DOMContentLoaded",s),ko.subscribable.fn.subscribeChanged=function(e){let t;this.subscribe((function(e){t=e}),void 0,"beforeChange"),this.subscribe((function(i){e(i,t)}))};class n{data={activities:ko.observableArray([]),selected_activities:ko.observableArray([]),organizations:ko.observableArray([]),selected_organizations:ko.observableArray([]),text:ko.observable("")};constructor(){const e=document.getElementById("search-organization");ko.cleanNode(e),ko.applyBindings(this.data,e),this.data.text.subscribe((e=>{this.search()})),this.data.selected_activities.subscribe((e=>{this.search()}))}reset(){$("#search-organization-activities").val([]).trigger("change"),this.data.text("")}search(){let e=[];const t=g();if(""!==this.data.text()||this.data.selected_organizations().length>0||this.data.selected_activities().length>0){const i=new RegExp(this.data.text(),"i");if(e=this.data.organizations().filter((e=>e.name.match(i))),this.data.selected_organizations().length>0&&(e=e.filter((e=>this.data.selected_organizations().some((t=>t.id===e.id))))),this.data.selected_activities().length>0){let t=[];for(const e of this.data.selected_activities())t.push(...u(this.data.activities(),e.id));t=[...new Set(t)],e=e.filter((e=>t.some((t=>t===e.activity_id))))}this.addInfoCards(t,e.slice(0,10),e.length)}else _(null);createJsSlidedowns()}addInfoCards=(t,i,a)=>{const s=[];for(const t of i)s.push(`\n    <div class="col-12 mb-4">\n      <div class="js-slidedown slidedown">\n        <button class="js-slidedown-toggler slidedown__toggler" type="button" aria-expanded="false">\n          <span>${t.name}</span>\n          <span class="slidedown__toggler__info">\n          ${b([t.email,t.street])}\n          </span>\n        </button>\n        <div class="js-slidedown-content slidedown__content">\n          <p>\n            ${t.description}\n            <ul>\n                <li>Hjemmeside: ${t.homepage}</li>\n                <li>Tlf: ${t.phone}</li>\n                <li>E-post: ${t.email}</li>\n                <li>Adresse: ${t.street}</li>\n                <li>Postnr: ${t.zip_code}</li>\n                <li>Poststed: ${t.city}</li>\n                <li>Distrikt: ${t.district}</li>\n                <li><a href="${e("bookingfrontend/",{menuaction:"bookingfrontend.uiorganization.show",id:t.id},!1)}">Mer info</a></li>\n            </ul>\n          </p> \n        </div>\n      </div>\n    </div>\n`);t.append(s.join("")),_(i,a)}}class o{data={towns_data:ko.observableArray([]),towns:ko.observableArray([]),selected_town:ko.observable(),buildings:ko.observableArray([]),selected_buildings:ko.observableArray([]),building_resources:ko.observableArray([]),activities:ko.observableArray([]),selected_activities:ko.observableArray([]),resource_activities:ko.observableArray([]),resource_categories:ko.observableArray([]),selected_resource_categories:ko.observableArray([]),resource_category_activity:ko.observableArray([]),resources:ko.observableArray([]),selected_resources:ko.observableArray([]),facilities:ko.observableArray([]),selected_facilities:ko.observableArray([]),resource_facilities:ko.observableArray([]),text:ko.observable(""),date:ko.observable(l(new Date)),show_only_available:ko.observable(!1),result:ko.observableArray([]),result_all:ko.observableArray([]),available_resources:ko.observableArray([]),taken_allocations:ko.observableArray([]),seasons:ko.observableArray([]),resources_with_available_time:ko.observableArray([]),easy_booking_available_ids:ko.observableArray([])};activity_cache={};allocation_cache={};easy_booking_available_cache={};easy_booking_not_available_cache={};lang="no";constructor(){this.lang=function(e){let t="selected_lang=",i=decodeURIComponent(document.cookie).split(";");for(let e=0;e<i.length;e++){let a=i[e];for(;" "==a.charAt(0);)a=a.substring(1);if(0==a.indexOf(t))return a.substring(14,a.length)}return""}()||"no";const e=document.getElementById("search-booking");ko.cleanNode(e),ko.applyBindings(this.data,e),this.updateBuildings(null),this.data.text.subscribe((e=>this.searchFetch())),this.data.selected_buildings.subscribe((e=>this.searchFetch())),this.data.selected_resource_categories.subscribe((e=>this.searchFetch())),this.data.selected_facilities.subscribe((e=>this.searchFetch())),this.data.selected_activities.subscribe((e=>this.searchFetch())),this.data.show_only_available.subscribe((e=>{e||this.data.resources_with_available_time([]),this.searchFetch()})),this.data.towns.subscribe((e=>this.updateBuildings(null))),this.data.date.subscribe((e=>{""!==e?this.searchFetch():this.data.date(l(new Date))})),this.data.selected_town.subscribe((e=>{this.updateBuildings(e),this.searchFetch()})),this.data.towns_data.subscribe((e=>{this.data.towns([...new Set(e.map((e=>e.name)))].sort(((e,t)=>e.localeCompare(t,"no"))).map((t=>({name:p(t),id:e.find((e=>e.name===t)).id}))))})),this.data.activities.subscribe((e=>{for(const t of e)this.activity_cache[t.id]=u(e,t.id)})),this.data.result_all.subscribeChanged(((e,t)=>{(function(e,t){if(e.length!==t.length)return!1;for(let i=0;i<e.length;i++)if(e[i]!==t[i])return!1;return!0})(e.map((e=>e.id)).sort(),t.map((e=>e.id)).sort())||this.data.show_only_available()&&this.fetchAvailableResources()}))}fetchEasyBooking(t){const i=`${this.data.date()}`,a=`${this.data.date()}`;i in this.easy_booking_available_cache||(this.easy_booking_available_cache[i]=[],this.easy_booking_not_available_cache[i]=[]);const s=[...new Set(this.data.result_all().filter((e=>!this.easy_booking_not_available_cache[i].includes(e.id)&&!this.easy_booking_available_cache[i].includes(e.id))).map((e=>e.id)))];if(0===s.length)return void t();const n=e("bookingfrontend/",{menuaction:"bookingfrontend.uibooking.get_freetime_limit",start_date:i,end_date:a,resource_ids:s.join(","),length:-1},!0);$.ajax({url:n,success:e=>{this.populate_easy_booking_available_cache(e,i,s),t()},error:e=>{console.log(e),t()}})}fetchAvailableResources(){let t=!1,i=!1;const a=`${this.data.date()} 00:00:00`,s=`${this.data.date()} 23:59:59`,n=()=>{t&&i&&(this.data.available_resources([]),this.data.taken_allocations(this.data.result_all().filter((e=>1!==e.simple_booking)).map((e=>this.allocation_cache[a].allocations[e.id])).flat()),this.data.seasons(this.data.result_all().filter((e=>1!==e.simple_booking)).map((e=>this.allocation_cache[a].seasons[e.id])).flat()),this.calculateAvailableResources(),this.search())};this.fetchEasyBooking((()=>{t=!0,n()})),a in this.allocation_cache||(this.allocation_cache[a]={},this.allocation_cache[a].allocations={},this.allocation_cache[a].seasons={});const o=[...new Set(this.data.result_all().filter((e=>1!==e.simple_booking)).filter((e=>!(e.id in this.allocation_cache[a].allocations))).map((e=>e.id)))];if(0===o.length)return i=!0,void n();const r=e("bookingfrontend/",{menuaction:"bookingfrontend.uisearch.search_available_resources",from_date:a,to_date:s,resource_ids:o.join(","),length:-1},!0);$.ajax({url:r,success:e=>{this.populate_allocation_cache(e,a,o),i=!0,n()},error:e=>{console.log(e)}})}populate_allocation_cache=(e,t,i)=>{const a=this.allocation_cache[t];i.map((e=>{e in a.allocations||(a.allocations[e]=[]),e in a.seasons||(a.seasons[e]=[])})),e.allocations.map((e=>{a.allocations[e.resource_id].push(e)})),e.seasons.map((e=>{a.seasons[e.resource_id].push(e)}))};populate_easy_booking_available_cache=(e,t,i)=>{const a=this.easy_booking_available_cache[t];Object.keys(e).map((t=>{e[t].map((e=>{e.overlap||a.push(e.applicationLink.resource_id)}))})),this.easy_booking_available_cache[t]=[...new Set(a)],this.easy_booking_not_available_cache[t]=[...new Set(i.filter((e=>!this.easy_booking_available_cache[t].includes(e))))]};reset(){this.data.selected_town(null),$("#search-booking-activities").val([]).trigger("change"),$("#search-booking-building").val([]).trigger("change"),$("#search-booking-resource_categories").val([]).trigger("change"),$("#search-booking-facilities").val([]).trigger("change"),this.data.text(""),this.data.date(l(new Date))}searchFetch(){this.data.show_only_available()?this.fetchAvailableResources():this.search()}search(){let e=[],t=!1;if((void 0!==this.data.selected_town()||this.data.selected_buildings().length>0||this.data.selected_facilities().length>0||this.data.selected_activities().length>0||this.data.selected_resource_categories().length>0)&&(e=this.data.resources(),void 0!==this.data.selected_town()&&(e=e.filter((e=>this.data.building_resources().some((t=>this.data.buildings().some((i=>i.id===t.building_id&&e.id===t.resource_id))))))),this.data.selected_buildings().length>0&&(e=e.filter((e=>this.data.building_resources().some((t=>this.data.selected_buildings().some((i=>i.id===t.building_id&&e.id===t.resource_id))))))),this.data.selected_facilities().length>0&&(e=e.filter((e=>this.data.selected_facilities().map((e=>e.id)).every((t=>this.data.resource_facilities().some((i=>i.resource_id===e.id&&i.facility_id===t))))))),this.data.selected_activities().length>0&&(e=e.filter((e=>this.data.selected_activities().map((e=>e.id)).every((t=>this.data.resource_activities().some((i=>this.activity_cache[t].includes(i.activity_id)&&e.id===i.resource_id))))))),this.data.selected_resource_categories().length>0&&(e=e.filter((e=>this.data.selected_resource_categories().some((t=>t.id===e.rescategory_id))))),t=!0),""!==this.data.text()){t||(e=this.data.resources());const i=new RegExp(this.data.text(),"i");let a=[],s=[];if(0===this.data.selected_buildings().length){const e=this.data.buildings().filter((e=>e.name.match(i)));a=this.getResourcesFromBuildings(e)}if(0===this.data.selected_activities().length){const e=this.data.activities().filter((e=>e.name.match(i))).map((e=>this.activity_cache[e.id])),t=this.data.resource_activities(),a=new Set(e.flatMap((e=>e.flatMap((e=>t.filter((t=>t.activity_id===e)))))).map((e=>e.resource_id)));s=this.data.resources().filter((e=>a.has(e.id)))}e=[...e.filter((e=>e.name.match(i)||a.some((t=>t.id===e.id)))),...s],t=!0}const i=g();t?(e=e.reduce(((e,t)=>(-1===e.findIndex((e=>e.id===t.id))&&e.push(t),e)),[]),this.data.result_all(e),this.data.show_only_available()&&(e=e.filter((e=>this.data.resources_with_available_time().includes(e.id)))),this.addInfoCards(i,e.sort(((e,t)=>e.name.localeCompare(t.name))))):(_(null),this.addInfoCards(i,[])),createJsSlidedowns()}calculateAvailableResources=()=>{const e=e=>{const[t,i,a]=e.split(":");return+a+60*+i+3600*+t},t=(e,t)=>{const i=new Date(e.split(" ")[0]),a=new Date(t.split(" ")[0]);return i.getDate()===a.getDate()&&i.getMonth()===a.getMonth()&&i.getFullYear()===a.getFullYear()},i=(e=>{const[t,i,a]=this.data.date().split(".");return new Date(`${a}-${i}-${t}`)})(this.data.date()).getDay(),a=this.data.taken_allocations().reduce(((i,a)=>(i[a.resource_id]=i[a.resource_id]||[],i[a.resource_id].push([e(a.from_.split(" ")[1]),t(a.from_,a.to_)?e(a.to_.split(" ")[1]):86400]),i)),{}),s=this.data.seasons().reduce(((t,a)=>(a.wday===i&&(a.resource_id in t||(t[a.resource_id]=[]),t[a.resource_id].push([e(a.from_time),e(a.to_time)])),t)),{}),n=Object.keys(s).filter((e=>!(e in a)||!((e,t)=>{e.sort(((e,t)=>e[0]-t[0]));const i=[e[0]];for(let t=1;t<e.length;t++){const a=i[i.length-1];e[t][0]<=a[1]?a[1]=Math.max(a[1],e[t][1]):i.push(e[t])}return i.reduce(((e,t)=>e+(t[1]-t[0])),0)>=t.reduce(((e,t)=>e+(t[1]-t[0])),0)})(a[e],s[e]))).map((e=>+e));this.data.resources_with_available_time([...new Set([...n,...this.easy_booking_available_cache[this.data.date()]])])};updateBuildings=(e=null)=>{this.data.buildings(this.data.towns_data().filter((t=>!e||e.id===t.id)).map((e=>({id:e.b_id,name:p(e.b_name),original_id:e.original_b_id,remoteInstance:e.remoteInstance}))).sort(((e,t)=>e.name?.localeCompare(t.name,"no"))))};getResourcesFromBuildings=e=>{const t=e.map((e=>e.id));return this.data.building_resources().filter((e=>t.includes(e.building_id))).map((e=>this.data.resources().find((t=>t.id===e.resource_id)))).filter((e=>!!e))};getBuildingsFromResource=e=>{const t=this.data.building_resources().filter((t=>t.resource_id===e)).map((e=>e.building_id));return this.data.buildings().filter((e=>t.includes(e.id)))};getTownFromBuilding=e=>{const t=e.map((e=>e.id));return this.data.towns_data().filter((e=>t.includes(e.b_id)))};cleanTownName=e=>e.split("\n").map((e=>(e.toLowerCase().includes("bydel")&&(e=e.replace(/bydel/gi,"").trim()),e.charAt(0).toUpperCase()+e.slice(1).toLowerCase()))).join("\n");addInfoCards(t,i){const a=[],s=[];for(const t of i){const i=this.getBuildingsFromResource(t.id),n=this.getTownFromBuilding(i);if(n.length>0){const o=`calendar-${t.id}`;s.push(t);const r=JSON.parse(t.description_json),l=(new DOMParser).parseFromString(r[this.lang]||r.no,"text/html").documentElement.textContent;let c="";c=1===t.simple_booking?e("bookingfrontend/",{menuaction:"bookingfrontend.uiresource.show",building_id:i[0].id,id:t.id},!1):e("bookingfrontend/",{menuaction:"bookingfrontend.uiapplication.add",building_id:i[0].id,resource_id:t.id},!1);const d=e("bookingfrontend/",{menuaction:"bookingfrontend.uibuilding.show",id:i[0].id});console.log(t.name,i),a.push(`\n                            <div class="col-12 mb-4">\n                                <div class="js-slidedown slidedown">\n                                    <button class="js-slidedown-toggler slidedown__toggler" type="button" aria-expanded="false">\n                                        <span><div class="fa-solid fa-layer-group"></div> ${t.name}</span>\n                                        <span class="slidedown__toggler__info">\n                ${b([t.remoteInstance?.name?`<span class="text-overline">${t.remoteInstance?.name}</span>`:"",`<span class="text-overline">${b(n.map((e=>this.cleanTownName(e.name))))}</span>`,...i.map((t=>`<a href="${e("bookingfrontend/",{menuaction:"bookingfrontend.uibuilding.show",id:"original_id"in t&&void 0!==t.original_id?t.original_id:t.id},!1,t.remoteInstance?.webservicehost||void 0)}" class="link-text link-text-primary"><i class="fa-solid fa-location-dot"></i>${t.name}</a>`))])}\n            </span>\n                                    </button>\n                                    <div class="js-slidedown-content slidedown__content">\n                                        <div>\n                                            \x3c!--                                            <div class="d-flex">--\x3e\n                                                \x3c!--<button class="pe-btn pe-btn-primary" style="margin-right: 8px;" onclick="location.href='${c}\n                                                    '">Søknad</button>--\x3e\n                                                \x3c!--<button class="pe-btn pe-btn-secondary"\n                                                        onclick="location.href='${d}'">${i[0].name}\n                                                </button>--\x3e\n                                            \x3c!--                                            </div>--\x3e\n                                            <p>\n                                                ${l}\n                                            </p>\n                                        </div>\n                                        <div id="${o}" class="calendar" data-building-id="${i[0].original_id||i[0].id}"\n                                             data-resource-id="${t.original_id||t.id}"\n                                             data-instance="${t.remoteInstance?.webservicehost||""}"\n                                             data-date="${h(this.data.date())}"></div>\n                                    </div>\n                                </div>\n                            </div>\n                    `)}}this.data.result(s.slice(0,50)),t.append(a.join("")),t.find("a.link-text").on("click",(function(e){e.stopPropagation()})),_(s.slice(0,50),s.length)}adjustMobilePositionOnSearch(){let e=document.getElementById("search-booking");setTimeout((function(){window.scrollTo(0,e.getBoundingClientRect().top)}),200)}}class r{data={text:ko.observable(""),from_date:ko.observable(l(new Date)),to_date:ko.observable(l(new Date((new Date).getTime()+6048e5))),events:ko.observableArray([])};constructor(){const e=document.getElementById("search-event");ko.cleanNode(e),ko.applyBindings(this.data,e),this.data.text.subscribe((e=>{this.search()})),this.data.from_date.subscribe((e=>{this.fetchEventOnDates()})),this.data.to_date.subscribe((e=>{this.fetchEventOnDates()}))}fetchEventOnDates(){const t=this.data.from_date()?.split("."),i=this.data.to_date()?.split(".");var a;const s=e("bookingfrontend/",{menuaction:"bookingfrontend.uieventsearch.upcoming_events",fromDate:t&&t.length>1?`${t[2]}-${t[1]}-${t[0]}T00:00:00`:`${(a=new Date).getFullYear()}-${a.getMonth()+1}-${a.getDate()}`,toDate:i&&i.length>1?`${i[2]}-${i[1]}-${i[0]}T23:59:59`:`${t[2]}-${t[1]}-${t[0]}T23:59:59`,buildingID:"",facilityTypeID:"",loggedInOrgs:"",start:0,end:1e3,length:-1},!0);$.ajax({url:s,success:e=>{this.data.events=e,this.search()},error:e=>{console.log(e)}})}reset(){this.data.text(""),this.data.from_date(l(new Date)),this.data.to_date("")}search(){let e=this.data.events.slice(0,5),t=this.data.events.length;const i=g();if(""!==this.data.text()){const i=new RegExp(this.data.text(),"i");e=this.data.events.filter((e=>e.event_name.match(i)||e.location_name.match(i))),t=e.length}this.addInfoCards(i,e,t),createJsSlidedowns()}addInfoCards(e,t,i){const a=[];for(const e of t)a.push(`\n    <div class="col-12 mb-4">\n      <div class="js-slidedown slidedown">\n        <button class="js-slidedown-toggler slidedown__toggler" type="button" aria-expanded="false">\n          <span>${e.event_name}</span>\n          <span class="slidedown__toggler__info">\n          ${b([e.location_name,d(new Date(e.from))+" - "+(new Date(e.from).getDate()===new Date(e.to).getDate()?c(new Date(e.to)):d(new Date(e.to)))])}\n          </span>\n        </button>\n        <div class="js-slidedown-content slidedown__content">\n          <p>\n            ${e.location_name}\n            <ul>\n                <li>Fra: ${e.from}</li>\n                <li>Til: ${e.to}</li>\n            </ul>\n          </p> \n        </div>\n      </div>\n    </div>\n`);e.append(a.join("")),_(t,i)}}function l(e){return`${e.getDate()}.${e.getMonth()+1}.${e.getFullYear()}`}function c(e){return`${("0"+e.getHours()).slice(-2)}:${("0"+e.getMinutes()).slice(-2)}`}function d(e){return`${l(e)} ${c(e)}`}function h(e){const t=e.replace(/[.\/]/g,"-"),[i,a,s]=t.split("-").map((e=>parseInt(e,10)));return luxon.DateTime.local(s,a,i).toJSDate()}function u(e,t){let i=[t];return e.filter((e=>e.parent_id===t)).map((t=>{i.push(...u(e,t.id))})),i}function g(){const e=$("#search-result");return e.empty(),e}function _(e,t=0){const i=$("#search-count");i.empty(),e&&i.append(`Antall treff: ${e.length}${t>0?" av "+t:""}`)}function p(e){const t=(new DOMParser).parseFromString(e,"text/html").documentElement.textContent;return(new DOMParser).parseFromString(t,"text/html").documentElement.textContent}function b(e){return e.map((e=>e&&e.length>0?`<span class="d-flex align-items-center">${e}</span>`:null)).filter((e=>e)).join('<span class="slidedown__toggler__info__separator"><i class="fa-solid fa-circle"></i></span>')}function m(e){return function(e,t){return e.sort(((e,i)=>e[t]?.localeCompare(i[t],"no")))}(e,"name")}new class{data={location:[],activities:[],resource_categories:[],resources:[],facilities:[],buildings:[],building_resources:[],organizations:[],events:[]};booking=new o;event=new r;organization=new n;ko_search={type_group:ko.observable(null),header_text_kword:ko.observable({}),header_sub_kword:ko.observable({})};constructor(){const e=document.getElementById("search-header");console.log(remote_search),ko.cleanNode(e),ko.applyBindings(this.ko_search,e),this.ko_search.type_group.subscribe((e=>{this.updateHeaderTexts(e)})),this.fetchData();const t=this;$(document).ready((function(){t.ko_search.type_group(location.hash.substring(1))})),$("#id-reset-filter").click((()=>{switch(t.ko_search.type_group()){case"booking":t.booking.reset();break;case"event":t.event.reset();break;case"organization":t.organization.reset()}}))}fetchData=()=>{const t=this,i=[fetch(e("bookingfrontend/",{menuaction:"bookingfrontend.uisearch.get_search_data_all",length:-1},!0)).then((e=>{if(!e.ok)throw new Error("Failed to fetch local data");return e.json()})),...remote_search.map((t=>{const i=e("bookingfrontend/",{menuaction:"bookingfrontend.uisearch.get_search_data_all",length:-1},!0,t.webservicehost);return fetch(i).then((e=>{if(!e.ok)throw new Error(`Failed to fetch data from ${t.webservicehost}`);return e.json()})).then((e=>function(e,t){const i=t.name,a=e=>`${i}-${e}`;return{...e,activities:e.activities.map((e=>({...e,original_id:e.id,id:a(e.id),original_parent_id:e.parent_id,parent_id:e.parent_id?a(e.parent_id):null}))),buildings:e.buildings.map((e=>({...e,original_id:e.id,id:a(e.id),original_activity_id:e.activity_id,activity_id:a(e.activity_id),remoteInstance:t}))),building_resources:e.building_resources.map((e=>({...e,original_building_id:e.building_id,building_id:a(e.building_id),original_resource_id:e.resource_id,resource_id:a(e.resource_id)}))),facilities:e.facilities.map((e=>({...e,original_id:e.id,id:a(e.id)}))),resources:e.resources.map((e=>({...e,original_id:e.id,id:a(e.id),original_rescategory_id:e.rescategory_id,rescategory_id:a(e.rescategory_id),remoteInstance:t}))),resource_activities:e.resource_activities.map((e=>({...e,original_resource_id:e.resource_id,resource_id:a(e.resource_id),original_activity_id:e.activity_id,activity_id:a(e.activity_id)}))),resource_facilities:e.resource_facilities.map((e=>({...e,original_resource_id:e.resource_id,resource_id:a(e.resource_id),original_facility_id:e.facility_id,facility_id:a(e.facility_id)}))),resource_categories:e.resource_categories.map((e=>({...e,original_id:e.id,id:a(e.id),original_parent_id:e.parent_id,parent_id:e.parent_id?a(e.parent_id):null}))),resource_category_activity:e.resource_category_activity.map((e=>({...e,original_rescategory_id:e.rescategory_id,rescategory_id:a(e.rescategory_id),original_activity_id:e.activity_id,activity_id:a(e.activity_id)}))),towns:e.towns.map((e=>({...e,original_b_id:e.b_id,b_id:a(e.b_id),original_id:e.id,id:a(e.id),remoteInstance:t}))),organizations:e.organizations.map((e=>({...e,original_id:e.id,id:a(e.id),original_activity_id:e.activity_id,activity_id:a(e.activity_id)})))}}(e,t))).catch((e=>(console.error(`Error fetching or processing data from ${t.webservicehost}: ${e}`),null)))}))];Promise.all(i).then((e=>{if(0===(e=e.filter((e=>null!==e))).length)throw new Error("No data retrieved from any source.");const i=e.reduce(((e,t,i)=>0===i?e:{...e,activities:[...e.activities,...t.activities],buildings:[...e.buildings,...t.buildings],building_resources:[...e.building_resources,...t.building_resources],facilities:[...e.facilities,...t.facilities],resources:[...e.resources,...t.resources],resource_activities:[...e.resource_activities,...t.resource_activities],resource_facilities:[...e.resource_facilities,...t.resource_facilities],resource_categories:[...e.resource_categories,...t.resource_categories],resource_category_activity:[...e.resource_category_activity,...t.resource_category_activity],towns:[...e.towns,...t.towns],organizations:[...e.organizations,...t.organizations]}),e[0]);t.data={...t.data,...i},t.booking.data.building_resources(i.building_resources),t.booking.data.towns_data(m(i.towns)),t.booking.data.activities(m(t.data.activities)),t.booking.data.resources(m(t.data.resources.map((e=>({...e,name:p(e.name)}))))),t.booking.data.facilities(m(t.data.facilities.map((e=>({...e,name:p(e.name)}))))),t.booking.data.resource_categories(m(t.data.resource_categories)),t.booking.data.resource_facilities(t.data.resource_facilities),t.booking.data.resource_activities(t.data.resource_activities),t.booking.data.resource_category_activity(t.data.resource_category_activity),t.event.data.events(t.data.events),t.organization.data.activities(m(t.data.activities.map((e=>({...e,name:p(e.name)}))))),t.organization.data.organizations(t.data.organizations.map((e=>({...e,name:p(e.name)}))))})).catch((e=>{console.log(e)}))};updateHeaderTexts=e=>{switch(e){case"booking":if(!landing_sections.booking){this.updateHeaderTexts();break}this.ko_search.header_text_kword({tag:"rent_premises_facilities_equipment",group:"bookingfrontend"}),this.ko_search.header_sub_kword({tag:"use_filters_to_find_rental_objects",group:"bookingfrontend"}),$("#search-booking").show(),$("#search-event").hide(),$("#search-organization").hide(),this.booking.search(),window.location.hash="#booking";break;case"event":if(!landing_sections.event){this.updateHeaderTexts();break}this.ko_search.header_text_kword({tag:"find_event_or_activity",group:"bookingfrontend"}),this.ko_search.header_sub_kword({tag:"use_filters_to_find_todays_events",group:"bookingfrontend"}),$("#search-event").show(),$("#search-booking").hide(),$("#search-organization").hide(),0===this.data.events.length&&this.event.fetchEventOnDates(),this.event.search(),window.location.hash="#event";break;case"organization":if(!landing_sections.organization){this.updateHeaderTexts();break}this.ko_search.header_text_kword({tag:"find_team_or_organization",group:"bookingfrontend"}),this.ko_search.header_sub_kword({tag:"search_for_like_minded_people",group:"bookingfrontend"}),$("#search-organization").show(),$("#search-booking").hide(),$("#search-event").hide(),this.organization.search(),window.location.hash="#organization";break;default:if(landing_sections.booking){this.ko_search.type_group("booking");break}if(landing_sections.event){this.ko_search.type_group("event");break}this.ko_search.type_group("organization")}}}})()})();