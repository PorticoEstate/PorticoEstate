(()=>{var e={792:()=>{ko.bindingHandlers.slidedownTarget={init:function(e,t){var i=t();"function"==typeof i&&i(e)}},ko.components.register("resource-info-card",{viewModel:function(e){this.resource=e.resource,this.buildings=ko.isObservable(e.buildings)?e.buildings():e.buildings,this.towns=e.towns,this.date=e.date,this.lang=e.lang,this.disableText=e.disableText||!1,this.expanded=ko.observable(!1),this.static=e.static||!1,this.filterGroups=e.filterGroups||void 0,this.cleanTownName=function(e){return e.split("\n").map((e=>(e.toLowerCase().includes("bydel")&&(e=e.replace(/bydel/gi,"").trim()),e.charAt(0).toUpperCase()+e.slice(1).toLowerCase()))).join("\n")},this.description_text=ko.computed((()=>{if(this.disableText)return"";const e=JSON.parse(this.resource.description_json);return(new DOMParser).parseFromString(this.lang&&e[this.lang]||e.no,"text/html").documentElement.textContent})),this.url=ko.computed((()=>this.buildings&&0!==this.buildings.length?1===this.resource.simple_booking?phpGWLink("bookingfrontend/",{menuaction:"bookingfrontend.uiresource.show",building_id:this.buildings?.[0].id,id:this.resource.id},!1):phpGWLink("bookingfrontend/",{menuaction:"bookingfrontend.uiapplication.add",building_id:this.buildings?.[0].id,resource_id:this.resource.id},!1):"")),this.locationUrl=ko.computed((()=>this.buildings&&0!==this.buildings.length?phpGWLink("bookingfrontend/",{menuaction:"bookingfrontend.uibuilding.show",id:this.buildings?.[0].id}):"")),this.calendarId=`calendar-${this.resource.id}`,this.infoText=ko.computed((()=>{const e=this.towns().map((e=>this.cleanTownName(e.name))).join(" • "),t=this.buildings?.map((e=>`<a href="${phpGWLink("bookingfrontend/",{menuaction:"bookingfrontend.uibuilding.show",id:void 0!==e.original_id?e.original_id:e.id},!1,e.remoteInstance?.webservicehost||void 0)}" class="link-text link-text-primary"><i class="fa-solid fa-location-dot"></i>${e.name}</a>`)).join(" • ");return[this.resource.remoteInstance?.name?`<span class="text-overline">${this.resource.remoteInstance?.name}</span>`:"",`<span class="text-overline">${e}</span>`,t].filter(Boolean).join(" • ")})),this.toggle=(e,t)=>{if("A"===t.target?.tagName)return!0;const i=t.target.closest(".js-slidedown.slidedown").querySelector(".js-slidedown-content.slidedown__content"),n=!this.expanded();return n?$(i).slideDown():$(i).slideUp(),this.expanded(n),!1}},template:'\n        <div class="col-12 mb-4">\n    <div class="js-slidedown slidedown">\n        <button class="js-slidedown-toggler slidedown__toggler" type="button" aria-expanded="false" data-bind="click: toggle">\n            <span><div class="fa-solid fa-layer-group"></div> <span data-bind="text: resource.name"></span></span>\n            <span class="slidedown__toggler__info" data-bind="html: infoText"></span>\n        </button>\n\n            <div class="js-slidedown-content slidedown__content">\n                \x3c!-- ko ifnot: disableText --\x3e\n                    <div>\n                        <p data-bind="html: description_text"></p>\n                    </div>\n                \x3c!-- /ko --\x3e\n\n                \x3c!-- ko if: expanded --\x3e\n                \x3c!-- ko if: date --\x3e\n                    \x3c!-- ko component: {\n                        name: \'pe-calendar\',\n                        params: {\n                            building_id: buildings[0].original_id || buildings[0].id,\n                            resource_id: resource.original_id || resource.id,\n                            instance: resource.remoteInstance?.webservicehost || \'\',\n                            dateString: date,\n                            nointeraction: static,\n                            filterGroups: filterGroups\n                        }\n                    } --\x3e\n                    \x3c!-- /ko --\x3e\n                    \x3c!-- /ko --\x3e\n                \x3c!-- /ko --\x3e\n            </div>\n    </div>\n</div>\n\n    '})},880:()=>{function e(e){if(/^\d{2}\/\d{2}\/\d{4} \d{2}:\d{2}$/.test(e))return e;if(/^\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}$/.test(e)){const[t,i]=e.split(" "),[n,s,a]=t.split("-"),[o,r]=i.split(":");return`${a}/${s}/${n} ${o}:${r}`}throw new Error("Invalid date format")}ko.components.register("time-slot-pill",{viewModel:function(t){const i=this;i.schedule=t.schedule,i.selectedResources=t.selectedResources,console.log(t),i.date=t.date,i.options={hour:"2-digit",minute:"2-digit"},console.log(i.date),i.startTime=ko.computed((()=>luxon.DateTime.fromFormat(e(i.date.from_),"dd/MM/yyyy HH:mm").toJSDate())),i.endTime=ko.computed((()=>luxon.DateTime.fromFormat(e(i.date.to_),"dd/MM/yyyy HH:mm").toJSDate())),i.toDateStr=e=>`${e.getDate()}. ${monthNamesShort[e.getMonth()].toLowerCase()}`,i.toTimeStr=(e,t)=>t?`${e.toLocaleTimeString("no",i.options).replace(":",".")} -\n                ${t.toLocaleTimeString("no",i.options).replace(":",".")}`:e.toLocaleTimeString("no",i.options).replace(":","."),i.removeDate=t.removeDate,i.error=ko.computed((()=>{if(!i.schedule||!i.selectedResources)return!1;const e={date:luxon.DateTime.fromJSDate(i.startTime()).toFormat("yyyy-MM-dd"),from:luxon.DateTime.fromJSDate(i.startTime()).toFormat("HH:mm:ss"),to:luxon.DateTime.fromJSDate(i.endTime()).toFormat("HH:mm:ss"),resources:i.selectedResources()},t=i.schedule().find((t=>function(e,t){if(e.date!==t.date)return!1;if("allocation"===t.type||"booking"===t.type)return!1;const i=e.from<t.to&&e.to>t.from,n=e.resources.some((e=>t.resources.some((t=>e.id===t.id))));return i&&n}(e,t)));return t?`${e.resources.find((e=>t.resources.some((t=>t.id===e.id)))).name} ikke tilgjengelig`:void 0}))},template:'\n\n        <div class="pill pill--secondary" data-bind="css: {\'pill--error\': error}">\n            \x3c!-- ko if: startTime().getMonth() === endTime().getMonth() && startTime().getFullYear() === endTime().getFullYear() && startTime().getDate() === endTime().getDate() --\x3e\n            <div class="pill-label">\n                <span className="text-primary text-bold" data-bind="text: toDateStr(startTime())"></span>\n            </div>\n            <div class="pill-divider"></div>\n            <div class="pill-time"\n                 data-bind="text: toTimeStr(startTime(), endTime()), css: {\'last-child\': !removeDate}">\n\n            </div>\n            \x3c!-- /ko --\x3e\n            \x3c!-- ko ifnot: (startTime().getMonth() === endTime().getMonth() && startTime().getFullYear() === endTime().getFullYear() && startTime().getDate() === endTime().getDate()) --\x3e\n            <div class="pill-content gap-1">\n                <div class="date"><span class="text-primary text-bold" data-bind="text: toDateStr(startTime())"></span>\n                    <span data-bind="text: toTimeStr(startTime())"></span>\n                </div>\n                <span> - </span>\n                <div class="time"><span class="text-primary text-bold" data-bind="text: toDateStr(endTime())"></span>\n                    <span data-bind="text: toTimeStr(endTime())"></span>\n                </div>\n            </div>\n\n            \x3c!-- /ko --\x3e\n\n            \x3c!-- ko if: !!removeDate --\x3e\n            <button class="pill-icon" data-bind="click: removeDate"><i class="pill-cross"></i></button>\n            \x3c!-- /ko --\x3e\n\n        </div>\n        \x3c!-- ko if: error --\x3e\n        <div class="d-flex align-items-center gap-2">\n            <svg class="font-size-small" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg">\n                <path d="M6.00011 0.75C6.33292 0.75 6.63996 0.925781 6.80871 1.21406L11.8712 9.83906C12.0423 10.1297 12.0423 10.4883 11.8759 10.7789C11.7095 11.0695 11.3978 11.25 11.0626 11.25H0.937611C0.602455 11.25 0.290736 11.0695 0.12433 10.7789C-0.042076 10.4883 -0.0397323 10.1273 0.129018 9.83906L5.19152 1.21406C5.36027 0.925781 5.6673 0.75 6.00011 0.75ZM6.00011 3.75C5.68839 3.75 5.43761 4.00078 5.43761 4.3125V6.9375C5.43761 7.24922 5.68839 7.5 6.00011 7.5C6.31183 7.5 6.56261 7.24922 6.56261 6.9375V4.3125C6.56261 4.00078 6.31183 3.75 6.00011 3.75ZM6.75011 9C6.75011 8.80109 6.67109 8.61032 6.53044 8.46967C6.38979 8.32902 6.19902 8.25 6.00011 8.25C5.8012 8.25 5.61043 8.32902 5.46978 8.46967C5.32913 8.61032 5.25011 8.80109 5.25011 9C5.25011 9.19891 5.32913 9.38968 5.46978 9.53033C5.61043 9.67098 5.8012 9.75 6.00011 9.75C6.19902 9.75 6.38979 9.67098 6.53044 9.53033C6.67109 9.38968 6.75011 9.19891 6.75011 9Z"\n                      fill="#B00020"/>\n            </svg>\n            <span class="text-small text-red-error" data-bind="text: error"></span>\n        </div>\n        \x3c!-- /ko --\x3e\n    '})},120:()=>{ko.bindingHandlers.select2={init:function(e,t,i){var n={theme:"select-v2",width:"100%",...t()||{}};$(e).select2(n),ko.utils.domNodeDisposal.addDisposeCallback(e,(function(){$(e).select2("destroy")}))},update:function(e,t,i){ko.unwrap(t());var n=i().selectedOptions,s=i().value;n&&0===ko.unwrap(n).length&&$(e).val(ko.unwrap(n)).trigger("change"),s&&void 0===ko.unwrap(s)&&$(e).val(ko.unwrap(s)).trigger("change")}},ko.bindingHandlers.datepicker={init:function(e,t,i){var n={dateFormat:"d.m.yy",changeMonth:!0,changeYear:!0,dayNames:["Søndag","Mandag","Tirsdag","Onsdag","Torsdag","Fredag","Lørdag"],dayNamesMin:["Sø","Ma","Ti","On","To","Fr","Lø"],dayNamesShort:["Søn","Man","Tir","Ons","Tor","Fre","Lør"],monthNames:["Januar","Februar","Mars","April","Mai","Juni","Juli","August","September","Oktober","November","Desember"],monthNamesShort,firstDay:1};$(e).datepicker(n),ko.utils.domNodeDisposal.addDisposeCallback(e,(function(){$(e).datepicker("destroy")}))}},ko.bindingHandlers.multiselectWithDatepicker={init:function(e,t,i){var n={select2Options:{theme:"select-v2 select-v2--main-search",width:"100%"},datepickerOptions:{dateFormat:"d.m.yy",changeMonth:!0,changeYear:!0,dayNames:["Søndag","Mandag","Tirsdag","Onsdag","Torsdag","Fredag","Lørdag"],dayNamesMin:["Sø","Ma","Ti","On","To","Fr","Lø"],dayNamesShort:["Søn","Man","Tir","Ons","Tor","Fre","Lør"],monthNames:["Januar","Februar","Mars","April","Mai","Juni","Juli","August","September","Oktober","November","Desember"],monthNamesShort,firstDay:1}};$(e).find(".js-select-multisearch").select2(n.select2Options),$(e).find("#datepicker").datepicker(n.datepickerOptions),$(e).find(".multisearch__inner__item").on("mouseDown",(function(){$(this).find("span .select2-container--open")?($(this).find(".js-select-multisearch").select2("open"),$(this).find("#datepicker").datepicker("show")):($(this).find(".js-select-multisearch").select2("close"),$(this).find("#datepicker").datepicker("hide"))})),ko.utils.domNodeDisposal.addDisposeCallback(e,(function(){$(e).find(".js-select-multisearch").select2("destroy"),$(e).find("#datepicker").datepicker("destroy")}));var s=i().selectedOptions;ko.isObservable(s)?s.subscribe((function(){$(e).find(".js-select-multisearch").val(ko.unwrap(s)).trigger("change")})):console.log("OH NO")},update:function(e,t,i){var n=i().selectedOptions;n&&(console.log("CHANGEVENT",ko.unwrap(n)),$(e).find(".js-select-multisearch").val(ko.unwrap(n)).trigger("change"))}},ko.bindingHandlers.toggleFilter={init:function(e,t){$(e).click((function(){$(this).toggleClass("toggle-filter--show"),$(".filter-element").toggleClass("d-block"),$(this).hasClass("toggle-filter--show")?$(this).text("Se færre filter"):$(this).text("Se flere filter")}))}}},940:()=>{if(!globalThis.trans){globalThis.translations=ko.observable({}),globalThis.translationsLoaded=ko.observable(!1);const e=phpGWLink("bookingfrontend/lang.php",null,!0);fetch(e).then((e=>e.json())).then((e=>{globalThis.translations(e),globalThis.translationsLoaded(!0)})),globalThis.trans=(e,t,...i)=>{const n=globalThis.translations(),s=e=>n[e]&&n[e][t]?n[e][t].replace(/%\d+/g,(e=>{const t=parseInt(e.substring(1))-1;return void 0!==i[t]?i[t]:e})):null;if(Array.isArray(e))for(let t=0;t<e.length;t++){const i=s(e[t]);if(null!==i)return i}else{const t=s(e);if(null!==t)return t}if(!Array.isArray(e)||!e.includes("common")){const e=s("common");if(null!==e)return e}return`Missing translation for [${Array.isArray(e)?e.join(", "):e}][${t}]`};class t{constructor(e,t){let i=t.templateNodes.map((e=>e.textContent));1===i.length&&i[0].includes(":")&&(i=i[0].split(":")),i=i.map((e=>e.trim())),i.length>=2?(this.tag=ko.observable(i[1]),this.group=ko.observable(i[0])):(this.tag="function"==typeof e.tag?e.tag:ko.observable(e.tag),this.group="function"==typeof e.group?e.group:ko.observable(e.group)),this.suffix=ko.observable(e.suffix||""),this.args=ko.observable(e.args),this.translations=globalThis.translations,this.translated=ko.computed((()=>{if(self.translations&&self.translations()&&Object.keys(self.translations()).length>0&&this.group&&this.tag)return globalThis.trans(this.group(),this.tag(),this.args())+this.suffix()}))}}ko.components.register("trans",{viewModel:{createViewModel:function(e,i){return new t(e,i)}},template:"\x3c!--ko text: translated()--\x3e\x3c!--/ko--\x3e"})}}},t={};function i(n){var s=t[n];if(void 0!==s)return s.exports;var a=t[n]={exports:{}};return e[n](a,a.exports,i),a.exports}(()=>{"use strict";function e(e,t,i,n){if(n){const e=n.split("/").filter((e=>""!==e&&!e.includes("http")));n="//"+e.slice(0,e.length-1).join("/")+"/"}const s=(n||strBaseURL).split("?");let a=s[0]+e+"?";null==t&&(t=new Object);for(const e in t)a+=e+"="+t[e]+"&";return s[1]&&(a+=s[1]),i&&(a+="&phpgw_return_as=json"),a}i(940),$(document).ready((function(){$("input[type=radio][name=select_template]").change((function(){var t=$(this).val(),i=e("bookingfrontend/",{menuaction:"bookingfrontend.preferences.set"},!0);$.ajax({type:"POST",dataType:"json",data:{template_set:t},url:i,success:function(e){location.reload(!0)}})})),$("input[type=radio][name=select_language]").change((function(){var t=$(this).val(),i=e("bookingfrontend/",{menuaction:"bookingfrontend.preferences.set"},!0);$.ajax({type:"POST",dataType:"json",data:{lang:t},url:i,success:function(e){location.reload(!0)}})}))})),i(880);class t{constructor(e){this.applicationCartItems=e.applicationCartItems,this.cartElementExpanded=ko.observable(!0),this.popperInstance=ko.observable(),this.isVisible=ko.observable(!1),this.deleteItem=e.deleteItem,this.applicationCartItems.subscribe((e=>console.log(e)))}initializePopper(e){const t=e.previousElementSibling;this.popperInstance(new Popper(t,e,{placement:"bottom-end",strategy:"fixed"}))}destroyPopperInstance(){this.popperInstance()&&(this.popperInstance().destroy(),this.popperInstance(null))}togglePopper(e=void 0){let t=this.popperInstance();t&&(this.isVisible(e||!this.isVisible()),t.update())}toggleCartExpansion(){this.cartElementExpanded(!this.cartElementExpanded())}popperAttr=ko.computed((()=>this.isVisible&&this.isVisible()?{"data-show":""}:{}))}ko.components.register("shopping-basket",{viewModel:{createViewModel:(e,i)=>new t(e,i)},template:'\n        <button class="pe-btn pe-btn--transparent menu__toggler" type="button" aria-expanded="false"\n                data-bind="click: () => togglePopper()">\n    <span class="text">\n        <i class="fa-solid fa-basket-shopping"></i>\n        <span class="badge badge-light" style="position: absolute;top: -5px;"\n              data-bind="visible: applicationCartItems().length > 0, text: applicationCartItems().length">-1\n        </span>\n    </span>\n        </button>\n        <div class="poppercontent"\n             style="z-index: 11"\n             data-bind="withAfterRender: {afterRender: (d) => initializePopper(d)}, visible: applicationCartItems().length > 0 && isVisible, attr: popperAttr()">\n            <div class="dialog-container">\n                <div class="dialog-header">\n                    <span class="dialog-title">Søknader klar for innsending</span>\n                    <button type="button" class="btn-close" data-bind="click: () => togglePopper(false)"\n                            aria-label="Close"></button>\n                </div>\n                <div class="dialog-ingress">\n                    <p>Her er en oversikt over dine søknader som er klar for innsending og godkjennelse.</p>\n                </div>\n                <div class="dialog-content">\n                    \x3c!-- Content goes here --\x3e\n                    <div class="article-table-wrapper" data-bind="visible: cartElementExpanded">\n                        <div data-bind="foreach: applicationCartItems">\n\n                            <div class="article-table-header title-only">\n                                <div class="resource-name d-flex gap-2 align-items-center">\n                                    <i class="fa-solid fa-location-dot"></i><h3 class="p-0 m-0" data-bind="text: building_name"></h3>\n                                </div>\n                                <div class="resource-expand float-right">\n                                    <span class="far fa-trash-alt mr-2" data-bind="click: () => $parent.deleteItem($data)"></span>\n                                </div>\n                            </div>\n                            <div class="category-table">\n\n                                    <div class="category-header category-article-row d-flex flex-wrap">\n                                        \x3c!-- ko foreach: { data: resources, as: \'item\' } --\x3e\n\n                                        <div class="pill pill">\n                                            <i class="fa-solid fa-layer-group"></i>\n                                            <div class="pill-label" data-bind="text: item.name"></div>\n                                        </div>\n                                        \x3c!-- /ko --\x3e\n\n                                    </div>\n\n                                <div class="category-articles">\n                                    <div class="category-article-row d-flex  flex-wrap">\n                                        \x3c!-- ko foreach: { data: dates, as: \'s\' } --\x3e\n                                        <time-slot-pill params="date: s"></time-slot-pill>\n                                        \x3c!-- /ko --\x3e\n\n                                    </div>\n                                </div>\n\n                            </div>\n                        </div>\n                    </div>\n                </div>\n                <div class="dialog-actions">\n                    <a class="pe-btn pe-btn-primary pe-btn-colour-primary link-text link-text-white d-flex gap-3"\n                       data-bind="attr: { href: phpGWLink(\'bookingfrontend/\', {menuaction:\'bookingfrontend.uiapplication.add_contact\' }, false) } ">\n                        <div class="text-bold">\n                            <trans params="group: \'bookingfrontend\', tag:\'complete_applications\'"></trans>\n                        </div>\n                        <div class="text-bold d-flex align-items-center">\n                            <i class="fa-solid fa-arrow-right-long"></i>\n                        </div>\n                    </a>\n                </div>\n            </div>\n        </div>\n    '});let n=new class{constructor(){this.applicationCartItems=ko.observableArray([]),this.applicationCartItemsEmpty=ko.observable(!1),this.visible=ko.observable(!0),this.initializeCart()}initializeCart(){this.getApplicationsCartItems()}deleteItem(t){var i,n,s;console.log("got delete request",this,t),(i=trans("bookingfrontend","delete_rentobject"),n=trans("bookingfrontend","delete_rentobject_body"),s=[trans("bookingfrontend","cancel"),trans("bookingfrontend","delete")],new Promise(((e,t)=>{const a=document.createElement("dialog");a.className="options-dialog";const o=document.createElement("div");o.className="options-dialog-title",o.textContent=i,a.appendChild(o);const r=document.createElement("div");r.className="options-dialog-body",r.textContent=n,a.appendChild(r);const l=document.createElement("div");l.className="options-dialog-options",s.forEach(((e,t)=>{const i=document.createElement("button");i.textContent=e,i.className="pe-btn  pe-btn--transparent pe-btn-text-primary",i.onclick=()=>{a.close(t)},l.appendChild(i)})),a.appendChild(l),a.addEventListener("close",(()=>{a.returnValue?e(a.returnValue):t(new Error("Dialog closed without selection")),a.remove()})),document.body.appendChild(a),a.showModal()}))).then((i=>{if(1==+i){const i=e("bookingfrontend/",{menuaction:"bookingfrontend.uiapplication.delete_partial"},!0);fetch(i,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:t.id})}).then((e=>e.json())).then((()=>this.getApplicationsCartItems())).catch((e=>console.error("Error:",e)))}})).catch((e=>{}))}getApplicationsCartItems(){const t=e("bookingfrontend/",{menuaction:"bookingfrontend.uiapplication.get_partials"},!0);fetch(t).then((e=>e.json())).then((e=>this.updateCartItems(e))).catch((e=>console.error("Error fetching cart items:",e)))}updateCartItems(e){const{list:t,total_sum:i}=e;this.applicationCartItemsEmpty(t.length<1),this.applicationCartItems(t.map((e=>({...e,dates:e.dates.map((e=>{const t=new Date(e.from_.replace(" ","T"));t.setHours(e.from_.substring(11,13)),t.setMinutes(e.from_.substring(14,16));const i=new Date(e.to_.replace(" ","T"));return i.setHours(e.to_.substring(11,13)),i.setMinutes(e.to_.substring(14,16)),{date:formatSingleDateWithoutHours(t),from_:e.from_,to_:e.to_,periode:formatPeriodeHours(t,i)}})),resources:ko.observableArray(e.resources.map((e=>({...e})))),joinedResources:e.resources.map((e=>e.name)).join(", ")}))))}};var s;function a(e){return`${e.getDate()}.${e.getMonth()+1}.${e.getFullYear()}`}function o(e){return`${("0"+e.getHours()).slice(-2)}:${("0"+e.getMinutes()).slice(-2)}`}function r(e){return`${a(e)} ${o(e)}`}function l(e,t){let i=[t];return e.filter((e=>e.parent_id===t)).map((t=>{i.push(...l(e,t.id))})),i}function c(e){const t=(new DOMParser).parseFromString(e,"text/html").documentElement.textContent;return(new DOMParser).parseFromString(t,"text/html").documentElement.textContent}function d(e){return e.map((e=>e&&e.length>0?`<span class="d-flex align-items-center">${e}</span>`:null)).filter((e=>e)).join('<span class="slidedown__toggler__info__separator"><i class="fa-solid fa-circle"></i></span>')}function h(e){return function(e,t){return e.sort(((e,i)=>e[t]?.localeCompare(i[t],"no")))}(e,"name")}s=()=>{const e=document.getElementById("application-cart-container")||document.getElementById("applications-cart-content");e&&(console.log("INITIALISING CART"),ko.applyBindings(n,e))},"complete"===document.readyState||"interactive"===document.readyState?setTimeout(s,1):document.addEventListener("DOMContentLoaded",s),i(792),i(120);class u{building_resources;towns_data;activities;resources;facilities;resource_categories;resource_activities;resource_category_activity;subscriptions=[];towns=ko.observableArray([]);selected_town=ko.observable();selected_buildings=ko.observableArray([]);selected_activities=ko.observableArray([]);selected_resource_categories=ko.observableArray([]);selected_resources=ko.observableArray([]);selected_facilities=ko.observableArray([]);text=ko.observable("");date=ko.observable(a(new Date));show_only_available=ko.observable(!1);result_all=ko.observableArray([]);available_resources=ko.observableArray([]);taken_allocations=ko.observableArray([]);seasons=ko.observableArray([]);resources_with_available_time=ko.observableArray([]);easy_booking_available_ids=ko.observableArray([]);show_more_filters=ko.observable(!1);result=ko.observableArray([]);result_shown=ko.observable(25);activity_cache={};allocation_cache={};easy_booking_available_cache={};easy_booking_not_available_cache={};lang="no";translationObservable=globalThis.translations;strings={search:ko.computed((function(){return globalThis.translations&&globalThis.translations(),trans("common","search")})),transCallable:ko.computed((function(){return globalThis.translations&&globalThis.translations(),trans}))};constructor(e){e.instance(this),this.building_resources=e.building_resources,this.towns_data=e.towns_data,this.activities=e.activities,this.resources=e.resources,this.facilities=e.facilities,this.resource_categories=e.resource_categories,this.resource_facilities=e.resource_facilities,this.resource_activities=e.resource_activities,this.resource_category_activity=e.resource_category_activity,this.lang=getCookie("selected_lang")||"no",this.show_only_available.subscribe((e=>{e||this.resources_with_available_time([]),this.searchFetch()})),this.towns_data.subscribe((e=>{this.towns([...new Set(e.map((e=>e.name)))].sort(((e,t)=>e.localeCompare(t,"no"))).map((t=>({name:c(t),id:e.find((e=>e.name===t)).id}))))})),this.activities.subscribe((e=>{for(const t of e)this.activity_cache[t.id]=l(e,t.id)})),this.result_all.subscribeChanged(((e,t)=>{(function(e,t){if(e.length!==t.length)return!1;for(let i=0;i<e.length;i++)if(e[i]!==t[i])return!1;return!0})(e.map((e=>e.id)).sort(),t.map((e=>e.id)).sort())||this.show_only_available()&&this.fetchAvailableResources()})),window.addEventListener("scroll",this.handleScroll.bind(this)),this.initializeComputed(),this.initializeSubscriptions()}initializeSubscriptions(){this.subscriptions=[this.text.subscribe((e=>this.searchFetch())),this.selected_buildings.subscribe((e=>this.searchFetch())),this.selected_resource_categories.subscribe((e=>this.searchFetch())),this.selected_facilities.subscribe((e=>this.searchFetch())),this.selected_activities.subscribe((e=>{this.searchFetch()})),this.date.subscribe((e=>{""!==e?this.searchFetch():this.date(a(new Date))})),this.selected_town.subscribe((e=>{this.searchFetch()}))]}initializeComputed(){this.buildings=ko.computed((()=>{if(!this.towns_data||!this.towns_data())return[];const e=this.selected_town();return this.towns_data().filter((t=>!e||e.id===t.id)).map((e=>({id:e.b_id,name:c(e.b_name),original_id:e.original_b_id,remoteInstance:e.remoteInstance}))).sort(((e,t)=>e.name?.localeCompare(t.name,"no")))}))}handleScroll(){window.scrollY+window.innerHeight>=document.documentElement.scrollHeight&&this.result_shown()<this.result().length&&this.result_shown(this.result_shown()+25)}fetchEasyBooking(t){const i=`${this.date()}`,n=`${this.date()}`;i in this.easy_booking_available_cache||(this.easy_booking_available_cache[i]=[],this.easy_booking_not_available_cache[i]=[]);const s=[...new Set(this.result_all().filter((e=>!this.easy_booking_not_available_cache[i].includes(e.id)&&!this.easy_booking_available_cache[i].includes(e.id))).map((e=>e.id)))];if(0===s.length)return void t();const a=e("bookingfrontend/",{menuaction:"bookingfrontend.uibooking.get_freetime_limit",start_date:i,end_date:n,resource_ids:s.join(","),length:-1},!0);$.ajax({url:a,success:e=>{this.populate_easy_booking_available_cache(e,i,s),t()},error:e=>{console.log(e),t()}})}fetchAvailableResources(){let t=!1,i=!1;const n=`${this.date()} 00:00:00`,s=`${this.date()} 23:59:59`,a=()=>{t&&i&&(this.available_resources([]),this.taken_allocations(this.result_all().filter((e=>1!==e.simple_booking)).map((e=>this.allocation_cache[n].allocations[e.id])).flat()),this.seasons(this.result_all().filter((e=>1!==e.simple_booking)).map((e=>this.allocation_cache[n].seasons[e.id])).flat()),this.calculateAvailableResources())};this.fetchEasyBooking((()=>{t=!0,a()})),n in this.allocation_cache||(this.allocation_cache[n]={},this.allocation_cache[n].allocations={},this.allocation_cache[n].seasons={});const o=[...new Set(this.result_all().filter((e=>1!==e.simple_booking)).filter((e=>!(e.id in this.allocation_cache[n].allocations))).map((e=>e.id)))];if(0===o.length)return i=!0,void a();const r=e("bookingfrontend/",{menuaction:"bookingfrontend.uisearch.search_available_resources",from_date:n,to_date:s,resource_ids:o.join(","),length:-1},!0);$.ajax({url:r,success:e=>{this.populate_allocation_cache(e,n,o),i=!0,a()},error:e=>{console.log(e)}})}populate_allocation_cache=(e,t,i)=>{const n=this.allocation_cache[t];i.map((e=>{e in n.allocations||(n.allocations[e]=[]),e in n.seasons||(n.seasons[e]=[])})),e.allocations.map((e=>{n.allocations[e.resource_id].push(e)})),e.seasons.map((e=>{n.seasons[e.resource_id].push(e)}))};populate_easy_booking_available_cache=(e,t,i)=>{const n=this.easy_booking_available_cache[t];Object.keys(e).map((t=>{e[t].map((e=>{e.overlap||n.push(e.applicationLink.resource_id)}))})),this.easy_booking_available_cache[t]=[...new Set(n)],this.easy_booking_not_available_cache[t]=[...new Set(i.filter((e=>!this.easy_booking_available_cache[t].includes(e))))]};reset(){for(const e of this.subscriptions)e.dispose();this.selected_town(null),this.selected_activities([]),this.selected_buildings([]),this.selected_resource_categories([]),this.selected_facilities([]),this.text(""),this.date(a(new Date)),this.initializeSubscriptions(),this.searchFetch()}searchFetch(){console.log("SEARCHING"),this.result_shown(25),this.show_only_available()?this.fetchAvailableResources():this.search()}search(){let e=[],t=!1;if((void 0!==this.selected_town()||this.selected_buildings().length>0||this.selected_facilities().length>0||this.selected_activities().length>0||this.selected_resource_categories().length>0)&&(e=this.resources(),void 0!==this.selected_town()&&(e=e.filter((e=>this.building_resources().some((t=>this.buildings().some((i=>i.id===t.building_id&&e.id===t.resource_id))))))),this.selected_buildings().length>0&&(e=e.filter((e=>this.building_resources().some((t=>this.selected_buildings().some((i=>i.id===t.building_id&&e.id===t.resource_id))))))),this.selected_facilities().length>0&&(e=e.filter((e=>this.selected_facilities().map((e=>e.id)).every((t=>this.resource_facilities().some((i=>i.resource_id===e.id&&i.facility_id===t))))))),this.selected_activities().length>0&&(e=e.filter((e=>this.selected_activities().map((e=>e.id)).every((t=>this.resource_activities().some((i=>this.activity_cache[t].includes(i.activity_id)&&e.id===i.resource_id))))))),this.selected_resource_categories().length>0&&(e=e.filter((e=>this.selected_resource_categories().some((t=>t.id===e.rescategory_id))))),t=!0),""!==this.text()){t||(e=this.resources());const i=new RegExp(this.text(),"i");let n=[],s=[];if(0===this.selected_buildings().length){const e=this.buildings().filter((e=>e.name.match(i)));n=this.getResourcesFromBuildings(e)}if(0===this.selected_activities().length){const e=this.activities().filter((e=>e.name.match(i))).map((e=>this.activity_cache[e.id])),t=this.resource_activities(),n=new Set(e.flatMap((e=>e.flatMap((e=>t.filter((t=>t.activity_id===e)))))).map((e=>e.resource_id)));s=this.resources().filter((e=>n.has(e.id)))}e=[...e.filter((e=>e.name.match(i)||n.some((t=>t.id===e.id)))),...s],t=!0}t?(e=e.reduce(((e,t)=>(-1===e.findIndex((e=>e.id===t.id))&&e.push(t),e)),[]),e=e.filter((e=>{const t=this.getBuildingsFromResource(e.id),i=this.getTownFromBuilding(t);return t.length>0&&i.length>0})),this.result_all(e),this.show_only_available()&&(e=e.filter((e=>this.resources_with_available_time().includes(e.id)))),console.log(e.length,"res"),this.result(e)):(function(e,t=0){const i=$("#search-count");i.empty(),e&&i.append(`Antall treff: ${e.length}${t>0?" av "+t:""}`)}(null),this.result([]))}showMoreResults(){this.result_shown(this.result_shown()+25)}calculateAvailableResources=()=>{const e=e=>{const[t,i,n]=e.split(":");return+n+60*+i+3600*+t},t=(e,t)=>{const i=new Date(e.split(" ")[0]),n=new Date(t.split(" ")[0]);return i.getDate()===n.getDate()&&i.getMonth()===n.getMonth()&&i.getFullYear()===n.getFullYear()},i=(e=>{const[t,i,n]=this.date().split(".");return new Date(`${n}-${i}-${t}`)})(this.date()).getDay(),n=this.taken_allocations().reduce(((i,n)=>(i[n.resource_id]=i[n.resource_id]||[],i[n.resource_id].push([e(n.from_.split(" ")[1]),t(n.from_,n.to_)?e(n.to_.split(" ")[1]):86400]),i)),{}),s=this.seasons().reduce(((t,n)=>(n.wday===i&&(n.resource_id in t||(t[n.resource_id]=[]),t[n.resource_id].push([e(n.from_time),e(n.to_time)])),t)),{}),a=Object.keys(s).filter((e=>!(e in n)||!((e,t)=>{e.sort(((e,t)=>e[0]-t[0]));const i=[e[0]];for(let t=1;t<e.length;t++){const n=i[i.length-1];e[t][0]<=n[1]?n[1]=Math.max(n[1],e[t][1]):i.push(e[t])}return i.reduce(((e,t)=>e+(t[1]-t[0])),0)>=t.reduce(((e,t)=>e+(t[1]-t[0])),0)})(n[e],s[e]))).map((e=>+e));this.resources_with_available_time([...new Set([...a,...this.easy_booking_available_cache[this.date()]])])};getResourcesFromBuildings=e=>{const t=e.map((e=>e.id));return this.building_resources().filter((e=>t.includes(e.building_id))).map((e=>this.resources().find((t=>t.id===e.resource_id)))).filter((e=>!!e))};getBuildingsFromResource=e=>{const t=this.building_resources().filter((t=>t.resource_id===e)).map((e=>e.building_id));return this.buildings().filter((e=>t.includes(e.id)))};getTownFromBuilding=e=>{const t=e.map((e=>e.id));return this.towns_data().filter((e=>t.includes(e.b_id)))};cleanTownName=e=>e.split("\n").map((e=>(e.toLowerCase().includes("bydel")&&(e=e.replace(/bydel/gi,"").trim()),e.charAt(0).toUpperCase()+e.slice(1).toLowerCase()))).join("\n");resLength=ko.computed((()=>{const e=this.result().length;return this.result_shown()>e||this.result_shown(),`Antall treff: ${e}`}));adjustMobilePositionOnSearch(){let e=document.getElementById("search-booking");setTimeout((function(){window.scrollTo(0,e.getBoundingClientRect().top)}),200)}onTextFocus(e,t){if(!isMobile())return!0;let i=t.target;for(;i&&"bodySection"!==i.className;)i=i.parentElement;i&&i.scrollIntoView({behavior:"smooth",block:"start"})}}ko.components.register("booking-search",{viewModel:{createViewModel:(e,t)=>new u(e,t)},template:'\n        <div id="search-booking">\n            <div class="bodySection">\n                <div class="multisearch w-100">\n                    <div class="multisearch__inner multisearch__inner--no-button w-100">\n                        <div class="row flex-column flex-md-row mb-lg-4">\n                            <div class="col col-md-6 col-lg-6 mb-3 mb-lg-0">\n                                <div class="multisearch__inner__item">\n                                    <label for="search-booking-text">\n                                        <trans>common:search</trans>\n                                    </label>\n                                    <input id="search-booking-text" type="text"\n                                           data-bind="textInput: text, attr: {placeholder: strings.search}, event: { focus: onTextFocus }"/>\n\n                                </div>\n                            </div>\n\n                            <div class="col col-md-6 col-lg-3 mb-3 mb-lg-0 multisearch__inner--border">\n                                <div class="multisearch__inner__item">\n                                    <label for="search-booking-datepicker">\n                                        <trans>common:date</trans>\n                                    </label>\n                                    <input type="text" id="search-booking-datepicker" placeholder="dd.mm.yyyy"\n                                           class="js-basic-datepicker" data-bind="textInput: date, datepicker"/>\n                                </div>\n                            </div>\n                            <div class="col col-md-6 col-lg-3 mb-3 mb-lg-0 multisearch__inner--border"\n                                 data-bind="css: {\'filter-element\': !show_more_filters()}">\n                                <div class="multisearch__inner__item ">\n                                    <label class="text-bold text-primary" for="search-booking-activities">\n                                        <trans>bookingfrontend:activity</trans>\n                                    </label>\n                                    <select class="js-select-multisearch" id="search-booking-activities"\n                                            multiple="true" data-bind="options: activities,\n            optionsText: \'name\',\n            selectedOptions: selected_activities,\n            attr: {\'aria-label\': strings.transCallable()(\'booking\',\'activities\')},\nselect2: {theme: \'select-v2 select-v2--main-search\'}\n            ">\n                                    </select>\n                                </div>\n                            </div>\n                        </div>\n                        <div class="row flex-column flex-md-row">\n                            <div class="col col-md-6 col-lg-3 mb-3 mb-lg-0"\n                                 data-bind="css: {\'filter-element\': !show_more_filters()}">\n                                <div class="multisearch__inner__item">\n                                    <label for="search-booking-area">\n                                        <trans>bookingfrontend:where</trans>\n                                    </label>\n                                    <select class="js-select-multisearch" id="search-booking-area"\n                                            data-bind="\n                                          options: towns,\n                                          optionsText: \'name\',\n                                          value: selected_town,\n                                          optionsCaption: strings.transCallable()(\'bookingfrontend\',\'district\'),\n                                          attr: {\'aria-label\': strings.transCallable()(\'bookingfrontend\',\'district\')},\n                                          select2: {theme: \'select-v2 select-v2--main-search\'}\n                                    ">\n                                    </select>\n                                </div>\n                            </div>\n                            <div class="col col-md-6 col-lg-3 mb-3 mb-lg-0 multisearch__inner--border"\n                                 data-bind="css: {\'filter-element\': !show_more_filters()}">\n                                <div class="multisearch__inner__item">\n                                    <label for="search-booking-building">\n                                        <trans>booking:what</trans>\n                                    </label>\n                                    <select class="js-select-multisearch" id="search-booking-building"\n                                            multiple="true"\n                                            data-bind="options: buildings,\n                            optionsText: \'name\',\n                            selectedOptions: selected_buildings,\n                            attr: {\'aria-label\': strings.transCallable()(\'bookingfrontend\',\'location\')},\nselect2: {theme: \'select-v2 select-v2--main-search\'}\n                            ">\n                                    </select>\n                                </div>\n                            </div>\n\n                            <div class="col col-md-6 col-lg-3 mb-3 mb-lg-0 multisearch__inner--border"\n                                 data-bind="css: {\'filter-element\': !show_more_filters()}">\n                                <div class="multisearch__inner__item">\n                                    <label class="text-bold text-primary" for="search-booking-resource_categories">\n                                        <trans>booking:type</trans>\n                                    </label>\n                                    <select class="js-select-multisearch" id="search-booking-resource_categories"\n                                            multiple="true" data-bind="options: resource_categories,\n            optionsText: \'name\',\n            selectedOptions: selected_resource_categories,\n            attr: {\'aria-label\': strings.transCallable()(\'booking\',\'resource_category\')},\nselect2: {theme: \'select-v2 select-v2--main-search\'}\n            ">\n                                    </select>\n                                </div>\n                            </div>\n                            <div class="col col-md-6 col-lg-3 mb-3 mb-lg-0 multisearch__inner--border"\n                                 data-bind="css: {\'filter-element\': !show_more_filters()}">\n                                <div class="multisearch__inner__item">\n                                    <label class="text-bold text-primary" for="search-booking-facilities">\n                                        <trans>bookingfrontend:facilities</trans>\n                                    </label>\n                                    <select class="js-select-multisearch" id="search-booking-facilities"\n                                            multiple="true" data-bind="options: facilities,\n            optionsText: \'name\',\n            selectedOptions: selected_facilities,\n            attr: {\'aria-label\': strings.transCallable()(\'bookingfrontend\',\'facilities\')},\nselect2: {theme: \'select-v2 select-v2--main-search\'}\n\n            ">\n                                    </select>\n                                </div>\n                            </div>\n                            <div class="d-flex d-md-none justify-content-end">\n                                <button id="js-toggle-filter"\n                                        class="pe-btn pe-btn-secondary align-self-end gap-2 d-flex"\n                                        data-bind="click: () => show_more_filters(!show_more_filters())">\n                                    \x3c!-- ko if: !show_more_filters() --\x3e\n                                    <trans>bookingfrontend:see_more_filters</trans>\n                                    \x3c!-- /ko --\x3e\n                                    \x3c!-- ko if: show_more_filters() --\x3e\n                                    <trans>bookingfrontend:see_less_filters</trans>\n                                    \x3c!-- /ko --\x3e\n                                    <i class="fa"\n                                       data-bind="css: {\'fa-chevron-up\': show_more_filters(), \'fa-chevron-down\': !show_more_filters()}"></i>\n                                    \n                                </button>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n            </div>\n\n            <div id="search-count" class="pt-3" data-bind="text: resLength"></div>\n\n            <div class="col-12 d-flex justify-content-start my-4 mb-md-0">\n                <input type="checkbox" id="show_only_available" class="checkbox-fa"\n                       data-bind="checked: show_only_available"/>\n                <label class="choice text-purple text-label" for="show_only_available">\n                    <i class="far fa-square unchecked-icon"></i>\n                    <i class="far fa-check-square checked-icon"></i>\n                    <trans>bookingfrontend:show_only_available</trans>\n                </label>\n            </div>\n\n            <div id="search-result" class="pt-3">\n                <div data-bind="foreach: { data: result.slice(0, result_shown()), as: \'resource\' }">\n                    <resource-info-card\n                            params="{ resource: resource, buildings: $parent.getBuildingsFromResource(resource.id), towns: $parent.getTownFromBuilding($parent.getBuildingsFromResource(resource.id)), lang: $parent.lang, towns_data: $parent.towns_data, date: $parent.date }"></resource-info-card>\n                </div>\n                \x3c!--                <button data-bind="visible: result_shown() < result().length, click: showMoreResults"--\x3e\n                \x3c!--                        class="btn btn-primary mt-3">Show More--\x3e\n                \x3c!--                </button>--\x3e\n            </div>\n        </div>\n    '}),ko.components.register("organization-info-card",{viewModel:function(e){this.organization=e.organization,this.expanded=ko.observable(!1),this.infoText=ko.computed((()=>d([this.organization.remoteInstance?.name?`<span class="text-overline">${this.organization.remoteInstance?.name}</span>`:"",this.organization.email,this.organization.street].filter(Boolean))))},template:'\n        <div class="col-12 mb-4">\n            <a class="link-button " type="button" aria-expanded="false"\n               data-bind="attr: { href: phpGWLink(\'bookingfrontend/\', {menuaction: \'bookingfrontend.uiorganization.show\', id: organization.original_id !== undefined ? organization.original_id : organization.id}, false, organization.remoteInstance?.webservicehost || undefined) }">\n                <div style="min-height: 54px">\n                    <div class="font-weight-bold gap-2 d-flex align-items-center mb-1">\n                        <h3 class="m-0 fa-solid fa-futbol" style="font-size:20px"></h3>\n                        <h3 class="m-0" data-bind="text: organization.name">\n                        </h3>\n                    </div>\n                    <span class="slidedown__toggler__info" data-bind="html: infoText"></span>\n                </div>\n            </a>\n        </div>\n    '}),ko.components.register("organization-search",{viewModel:class{result=ko.observableArray([]);result_shown=ko.observable(25);show_only_available=ko.observable(!1);transCallable=ko.computed((function(){return globalThis.translations&&globalThis.translations(),trans}));constructor(e){e.instance(this),console.log(e),this.activities=e.activities,this.selected_activities=ko.observableArray([]),this.organizations=e.organizations,this.selected_organizations=ko.observableArray([]),this.text=ko.observable(""),this.text.subscribe((()=>this.search())),this.selected_activities.subscribe((()=>this.search())),window.addEventListener("scroll",this.handleScroll.bind(this))}reset(){$("#search-organization-activities").val([]).trigger("change"),this.text("")}search(){this.result_shown(25);let e=[];if(""!==this.text()||this.selected_organizations().length>0||this.selected_activities().length>0){const t=new RegExp(this.text(),"i");if(e=this.organizations().filter((e=>e.name.match(t))),this.selected_organizations().length>0&&(e=e.filter((e=>this.selected_organizations().some((t=>t.id===e.id))))),this.selected_activities().length>0){let t=[];for(const e of this.selected_activities())t.push(...l(this.activities(),e.id));t=[...new Set(t)],e=e.filter((e=>t.some((t=>t===e.activity_id))))}console.log(e),this.result(e)}else this.result([])}handleScroll(){window.scrollY+window.innerHeight>=document.documentElement.scrollHeight&&this.result_shown()<this.result().length&&this.result_shown(this.result_shown()+25)}resLength=ko.computed((()=>{const e=this.result().length;return this.result_shown()>e||this.result_shown(),`Antall treff: ${e}`}))},template:'\n        <div id="search-organization">\n            <div class="bodySection">\n                <div class="multisearch w-100 mb-5">\n                    <div class="multisearch__inner w-100">\n                        <div class="row flex-column flex-md-row">\n                            <div class="col mb-3 mb-md-0">\n                                <div class="multisearch__inner__item">\n                                    <label for="search-organization-text">\n                                        <trans>common:search</trans>\n                                    </label>\n                                    <input id="search-organization-text" type="text"\n                                           data-bind="textInput: text, attr: {\'placeholder\': transCallable()(\'bookingfrontend\',\'enter_team_organization_name\')}"/>\n\n                                </div>\n                            </div>\n                            <div class="col mb-3 mb-md-0">\n                                <div class="multisearch__inner__item">\n                                    <label class="text-bold text-primary" for="search-organization-activities">\n                                        <trans>bookingfrontend:activity</trans>\n                                    </label>\n                                    <select class="js-select-multisearch" id="search-organization-activities"\n                                            multiple="true" data-bind="\n                                                options: activities,\n                                                optionsText: \'name\',\n                                                selectedOptions: selected_activities,\n                                                attr: {\'aria-label\': transCallable()(\'booking\',\'activities\')},\n                                                select2: {theme: \'select-v2 select-v2--main-search\'}\n                                                ">\n                                    </select>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n            </div>\n            <div id="search-count" class="pt-3" data-bind="text: resLength"></div>\n\n            \x3c!--            <div class="col-12 d-flex justify-content-start my-4 mb-md-0">--\x3e\n            \x3c!--                <input type="checkbox" id="show_only_available" class="checkbox-fa"--\x3e\n            \x3c!--                       data-bind="checked: show_only_available"/>--\x3e\n            \x3c!--                <label class="choice text-purple text-label" for="show_only_available">--\x3e\n            \x3c!--                    <i class="far fa-square unchecked-icon"></i>--\x3e\n            \x3c!--                    <i class="far fa-check-square checked-icon"></i>--\x3e\n            \x3c!--                    <trans>bookingfrontend:show_only_available</trans>--\x3e\n            \x3c!--                </label>--\x3e\n            \x3c!--            </div>--\x3e\n\n            <div id="search-result" class="pt-3">\n                <div data-bind="foreach: { data: result.slice(0, result_shown()), as: \'org\' }">\n                    <organization-info-card\n                            params="{ organization: org }"></organization-info-card>\n                </div>\n            </div>\n        </div>\n    '}),ko.components.register("event-info-card",{viewModel:function(e){this.event=e.event,this.expanded=ko.observable(!1),this.slideDownTarget=ko.observable();const t=this;t.addSlideDown=e=>{t.slideDownTarget(e)},t.toggle=(e,i)=>{if("A"===i.target?.tagName)return!0;const n=!this.expanded();return n?$(t.slideDownTarget()).slideDown():$(t.slideDownTarget()).slideUp(),t.expanded(n),!1},t.infoText=ko.computed((()=>d([this.event.remoteInstance?.name?`<span class="text-overline">${this.event.remoteInstance?.name}</span>`:"",this.event.location_name,r(new Date(this.event.from))+" - "+(new Date(this.event.from).getDate()===new Date(this.event.to).getDate()?o(new Date(this.event.to)):r(new Date(this.event.to)))].filter(Boolean))))},template:'\n        <div class="col-12 mb-4">\n          <div class="js-slidedown slidedown">\n            <button class="js-slidedown-toggler slidedown__toggler" type="button" aria-expanded="false" data-bind="click: toggle">\n              <span data-bind="text: event.event_name"></span>\n                                  <span class="slidedown__toggler__info" data-bind="html: infoText"></span>\n            </button>\n            <div class="js-slidedown-content slidedown__content" data-bind="withAfterRender: { afterRender: addSlideDown}">\n              <p data-bind="text: event.location_name"></p>\n              <ul>\n                  <li data-bind="text: \'Fra: \' + event.from"></li>\n                  <li data-bind="text: \'Til: \' + event.to"></li>\n              </ul>\n            </div>\n          </div>\n        </div>\n    '}),ko.components.register("event-search",{viewModel:class{text=ko.observable("");from_date=ko.observable(a(new Date));to_date=ko.observable(a(new Date((new Date).getTime()+6048e5)));events=ko.observableArray([]);result_shown=ko.observable(25);transCallable=ko.computed((function(){return globalThis.translations&&globalThis.translations(),trans}));constructor(){this.from_date.subscribe((e=>{console.log("FROM",e),this.fetchEventOnDates()})),this.to_date.subscribe((e=>{console.log("TO",e),this.fetchEventOnDates()})),this.fetchEventOnDates(),window.addEventListener("scroll",this.handleScroll.bind(this))}handleScroll(){window.scrollY+window.innerHeight>=document.documentElement.scrollHeight&&this.result_shown()<this.result().length&&this.result_shown(this.result_shown()+25)}fetchEventOnDates(){const t=this.from_date()?.split("."),i=this.to_date()?.split("."),n=e("bookingfrontend/",{menuaction:"bookingfrontend.uieventsearch.upcoming_events",fromDate:t&&t.length>1?`${t[2]}-${t[1]}-${t[0]}T00:00:00`:getIsoDateString(new Date),toDate:i&&i.length>1?`${i[2]}-${i[1]}-${i[0]}T23:59:59`:`${t[2]}-${t[1]}-${t[0]}T23:59:59`,buildingID:"",facilityTypeID:"",loggedInOrgs:"",start:0,end:1e3,length:-1},!0);$.ajax({url:n,success:e=>{this.events(e)},error:e=>{console.log(e)}})}reset(){this.text(""),this.from_date(a(new Date)),this.to_date("")}result=ko.computed((()=>{if(console.log("rescall"),!this.events())return[];this.result_shown(25);let e=this.events();if(""!==this.text()){const t=new RegExp(this.text(),"i");e=this.events().filter((e=>e.event_name.match(t)||e.location_name.match(t)))}return console.log(e),e}));resLength=ko.computed((()=>`Antall treff: ${this.result().length}`))},template:'\n        <div id="search-event">\n            <div class="bodySection">\n                <div class="multisearch w-100 mb-5">\n                    <div class="multisearch__inner w-100">\n                        <div class="row flex-column flex-md-row">\n                            <div class="col mb-3 mb-md-0">\n                                <div class="multisearch__inner__item">\n                                    <label for="search-event-text">\n                                        <trans>common:search</trans>\n                                    </label>\n                                    <input id="search-event--text" type="text"\n                                           data-bind="textInput: text, attr: {\'placeholder\': transCallable()(\'bookingfrontend\',\'event_building\')}"/>\n                                </div>\n                            </div>\n                            <div class="col mb-3 mb-md-0 multisearch__inner--border">\n                                <div class="multisearch__inner__item">\n                                    <label for="search-event-datepicker-from">\n                                        <trans params="{tag: \'from_date\', group: \'bookingfrontend\'}"></trans>\n                                    </label>\n                                    <input type="text" id="search-event-datepicker-from" class="js-basic-datepicker"\n                                           placeholder="dd.mm.yyyy" data-bind="textInput: from_date, datepicker"/>\n                                </div>\n                            </div>\n                            <div class="col mb-3 mb-md-0 multisearch__inner--border">\n                                <div class="multisearch__inner__item">\n                                    <label for="search-event-datepicker-to">\n                                        <trans params="{tag: \'to_date\', group: \'bookingfrontend\'}"></trans>\n                                    </label>\n                                    <input type="text" id="search-event-datepicker-to" class="js-basic-datepicker"\n                                           placeholder="dd.mm.yyyy" data-bind="textInput: to_date, datepicker"/>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n            </div>\n\n            <div id="search-count" class="pt-3" data-bind="text: resLength"></div>\n\n            \x3c!--            <div class="col-12 d-flex justify-content-start my-4 mb-md-0">--\x3e\n            \x3c!--                <input type="checkbox" id="show_only_available" class="checkbox-fa"--\x3e\n            \x3c!--                       data-bind="checked: show_only_available"/>--\x3e\n            \x3c!--                <label class="choice text-purple text-label" for="show_only_available">--\x3e\n            \x3c!--                    <i class="far fa-square unchecked-icon"></i>--\x3e\n            \x3c!--                    <i class="far fa-check-square checked-icon"></i>--\x3e\n            \x3c!--                    <trans>bookingfrontend:show_only_available</trans>--\x3e\n            \x3c!--                </label>--\x3e\n            \x3c!--            </div>--\x3e\n\n            <div id="search-result" class="pt-3">\n                <div data-bind="foreach: { data: result().slice(0, result_shown()), as: \'event\' }">\n                    <event-info-card\n                            params="{ event: event }"></event-info-card>\n                </div>\n            </div>\n\n        </div>\n    '}),ko.subscribable.fn.subscribeChanged=function(e){let t;this.subscribe((function(e){t=e}),void 0,"beforeChange"),this.subscribe((function(i){e(i,t)}))},new class{data={location:ko.observableArray([]),activities:ko.observableArray([]),resource_categories:ko.observableArray([]),resources:ko.observableArray([]),facilities:ko.observableArray([]),buildings:ko.observableArray([]),building_resources:ko.observableArray([]),organizations:ko.observableArray([]),events:ko.observableArray([]),towns:ko.observableArray([]),resource_activities:ko.observableArray([]),resource_facilities:ko.observableArray([]),resource_category_activity:ko.observableArray([])};booking=ko.observable();organization=ko.observable();event=ko.observable();ready=globalThis.translationsLoaded;type_group=ko.observable(null);header_text_kword=ko.observable({});header_sub_kword=ko.observable({});constructor(){const e=document.getElementById("search-page-content");console.log(remote_search),ko.cleanNode(e),ko.applyBindings(this,e),this.type_group.subscribe((e=>{this.updateHeaderTexts(e)})),this.fetchData();const t=this;$(document).ready((function(){t.type_group(location.hash.substring(1))}))}resetSearchFilter(){switch(this.type_group()){case"booking":this.booking().reset();break;case"event":this.event.reset();break;case"organization":this.organization().reset()}}fetchData=()=>{const t=this;AbortSignal.timeout??=function(e){const t=new AbortController;return setTimeout((()=>t.abort()),e),t.signal};const i=[fetch(e("bookingfrontend/",{menuaction:"bookingfrontend.uisearch.get_search_data_all",length:-1},!0)).then((e=>{if(!e.ok)throw new Error("Failed to fetch local data");return e.json()})),...remote_search.map((t=>{const i=e("bookingfrontend/",{menuaction:"bookingfrontend.uisearch.get_search_data_all",length:-1},!0,t.webservicehost);return fetch(i,{signal:AbortSignal.timeout(2500)}).then((e=>{if(!e.ok)throw new Error(`Failed to fetch data from ${t.webservicehost}`);return e.json()})).then((e=>function(e,t){const i=t.name,n=e=>`${i}-${e}`;return{...e,activities:e.activities.map((e=>({...e,original_id:e.id,id:n(e.id),original_parent_id:e.parent_id,parent_id:e.parent_id?n(e.parent_id):null}))),buildings:e.buildings.map((e=>({...e,original_id:e.id,id:n(e.id),original_activity_id:e.activity_id,activity_id:n(e.activity_id),remoteInstance:t}))),building_resources:e.building_resources.map((e=>({...e,original_building_id:e.building_id,building_id:n(e.building_id),original_resource_id:e.resource_id,resource_id:n(e.resource_id)}))),facilities:e.facilities.map((e=>({...e,original_id:e.id,id:n(e.id)}))),resources:e.resources.map((e=>({...e,original_id:e.id,id:n(e.id),original_rescategory_id:e.rescategory_id,rescategory_id:n(e.rescategory_id),remoteInstance:t}))),resource_activities:e.resource_activities.map((e=>({...e,original_resource_id:e.resource_id,resource_id:n(e.resource_id),original_activity_id:e.activity_id,activity_id:n(e.activity_id)}))),resource_facilities:e.resource_facilities.map((e=>({...e,original_resource_id:e.resource_id,resource_id:n(e.resource_id),original_facility_id:e.facility_id,facility_id:n(e.facility_id)}))),resource_categories:e.resource_categories.map((e=>({...e,original_id:e.id,id:n(e.id),original_parent_id:e.parent_id,parent_id:e.parent_id?n(e.parent_id):null}))),resource_category_activity:e.resource_category_activity.map((e=>({...e,original_rescategory_id:e.rescategory_id,rescategory_id:n(e.rescategory_id),original_activity_id:e.activity_id,activity_id:n(e.activity_id)}))),towns:e.towns.map((e=>({...e,original_b_id:e.b_id,b_id:n(e.b_id),original_id:e.id,id:n(e.id),remoteInstance:t}))),organizations:e.organizations.map((e=>({...e,original_id:e.id,id:n(e.id),original_activity_id:e.activity_id,activity_id:n(e.activity_id),remoteInstance:t})))}}(e,t))).catch((e=>(console.error(`Error fetching or processing data from ${t.webservicehost}: ${e}`),null)))}))];Promise.all(i).then((e=>{if(0===(e=e.filter((e=>null!==e))).length)throw new Error("No data retrieved from any source.");const i=e.reduce(((e,t,i)=>0===i?e:{...e,activities:[...e.activities,...t.activities],buildings:[...e.buildings,...t.buildings],building_resources:[...e.building_resources,...t.building_resources],facilities:[...e.facilities,...t.facilities],resources:[...e.resources,...t.resources],resource_activities:[...e.resource_activities,...t.resource_activities],resource_facilities:[...e.resource_facilities,...t.resource_facilities],resource_categories:[...e.resource_categories,...t.resource_categories],resource_category_activity:[...e.resource_category_activity,...t.resource_category_activity],towns:[...e.towns,...t.towns],organizations:[...e.organizations,...t.organizations]}),e[0]);for(const e in i)if(t.data[e]&&ko.isObservable(t.data[e])){let n=i[e];["resources","facilities","towns","activities","resource_categories","organizations"].some((t=>t===e))&&(n=h(h(n.map((e=>({...e,name:c(e.name)})))))),t.data[e](n)}})).catch((e=>{console.log(e)}))};updateHeaderTexts=e=>{switch(e){case"booking":if(!landing_sections.booking){this.updateHeaderTexts();break}this.header_text_kword({tag:"rent_premises_facilities_equipment",group:"bookingfrontend"}),this.header_sub_kword({tag:"use_filters_to_find_rental_objects",group:"bookingfrontend"}),this.booking()?.search(),window.location.hash="#booking";break;case"event":if(!landing_sections.event){this.updateHeaderTexts();break}this.header_text_kword({tag:"find_event_or_activity",group:"bookingfrontend"}),this.header_sub_kword({tag:"use_filters_to_find_todays_events",group:"bookingfrontend"}),this.event()?.search(),window.location.hash="#event";break;case"organization":if(!landing_sections.organization){this.updateHeaderTexts();break}this.header_text_kword({tag:"find_team_or_organization",group:"bookingfrontend"}),this.header_sub_kword({tag:"search_for_like_minded_people",group:"bookingfrontend"}),this.organization()?.search(),window.location.hash="#organization";break;default:if(landing_sections.booking){this.type_group("booking");break}if(landing_sections.event){this.type_group("event");break}this.type_group("organization")}}}})()})();